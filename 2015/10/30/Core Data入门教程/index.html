<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
    

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.4"/>


    <meta name="description" content="IOS技术总结" />



  <meta name="keywords" content="Core Data,本地存储,缓存," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.4" />


<meta name="description" content="本文是在斯坦福大学公开课 Lecture 12 : Core Data 、Lecture 13 Final Project Overview课程笔记的基础上，进行了修改和扩充。未接触过Core Data的朋友可以先看下这两节公开课。当然，您也可以直接看本教程，基本上课程中讲到的内容精华下文都会包含。
公开课中讲解的内容，主要是基于UIManagedDocument来管理Core Data。大家可能">
<meta property="og:type" content="article">
<meta property="og:title" content="Core Data入门教程">
<meta property="og:url" content="http://aliang9585.github.io/2015/10/30/Core Data入门教程/index.html">
<meta property="og:site_name" content="LYL's Blog">
<meta property="og:description" content="本文是在斯坦福大学公开课 Lecture 12 : Core Data 、Lecture 13 Final Project Overview课程笔记的基础上，进行了修改和扩充。未接触过Core Data的朋友可以先看下这两节公开课。当然，您也可以直接看本教程，基本上课程中讲到的内容精华下文都会包含。
公开课中讲解的内容，主要是基于UIManagedDocument来管理Core Data。大家可能">
<meta property="og:image" content="http://7xkfcm.com1.z0.glb.clouddn.com/CoreData-Relationship1.png">
<meta property="og:image" content="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataMyDocument@2x.png">
<meta property="og:image" content="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataSQLDebugArguments@2x.png">
<meta property="og:image" content="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataSqliteFile@2x.png">
<meta property="og:image" content="https://developer.apple.com/library/prerelease/tvos/documentation/Cocoa/Conceptual/CoreData/Art/Entity_Inspector_2x.png">
<meta property="og:updated_time" content="2015-11-22T12:34:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Core Data入门教程">
<meta name="twitter:description" content="本文是在斯坦福大学公开课 Lecture 12 : Core Data 、Lecture 13 Final Project Overview课程笔记的基础上，进行了修改和扩充。未接触过Core Data的朋友可以先看下这两节公开课。当然，您也可以直接看本教程，基本上课程中讲到的内容精华下文都会包含。
公开课中讲解的内容，主要是基于UIManagedDocument来管理Core Data。大家可能">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

    <title> Core Data入门教程 // LYL's Blog </title>
</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="">
<!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?a7a4364608485ad7bc5d2abeacd05591";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



<div class="container one-column page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
        <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">LYL's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-home"></i> <br />
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-categories"></i> <br />
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-about"></i> <br />
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-archives"></i> <br />
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-tags"></i> <br />
            標籤
          </a>
        </li>
      
    </ul>
  

  
</nav>


        </div>
    </header>

    <main id="main" class="main">
        <div class="main-inner">
            <div id="content" class="content">
                

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              Core Data入门教程
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於
          <time itemprop="dateCreated" datetime="2015-10-30T22:42:11+08:00" content="2015-10-30">
            2015-10-30
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分類於
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Core-Data/" itemprop="url" rel="index"><span itemprop="name">Core Data</span></a></span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/10/30/Core Data入门教程/#comments" itemprop="discussionUrl">
              <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/10/30/Core Data入门教程/" itemprop="commentsCount"></span>
            </a>
          </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>本文是在斯坦福大学公开课 <a href="http://open.163.com/movie/2014/1/1/D/M9H7S9F1H_M9H80SS1D.html" target="_blank" rel="external">Lecture 12 : Core Data </a>、<a href="http://open.163.com/movie/2014/1/5/5/M9H7S9F1H_M9H80V155.html" target="_blank" rel="external">Lecture 13 Final Project Overview</a>课程笔记的基础上，进行了修改和扩充。未接触过Core Data的朋友可以先看下这两节公开课。当然，您也可以直接看本教程，基本上课程中讲到的内容精华下文都会包含。</p>
<p>公开课中讲解的内容，主要是基于UIManagedDocument来管理Core Data。大家可能很难搜索到类似的资料。国内资料还是基于苹果官网做法-使用三大核心对象管理Core Data，因此我在课程笔记中，用红色标题来补充这些内容，请大家阅读时加以区分。在第一部分的末尾，我会给出这两种方式的完整代码。</p>
<p>本文整体内容比较初级，没有涉及Core Data中线程同步、缓存刷新、回滚操作、防止误删等内容，想学习这些内容的请关注我后续文章。</p>
<a id="more"></a>
<h2 id="第一部分：斯坦福大学IOS7公开课_Lecture_12_课程笔记">第一部分：斯坦福大学IOS7公开课 Lecture 12 课程笔记</h2><h3 id="1、创建工程">1、创建工程</h3><p>我们创建一个工程，名称叫CoreDataDemoWithoutTemplate，创建时不要勾选Use Core Data</p>
<h3 id="2、创建-xcdatamodeld文件">2、创建.xcdatamodeld文件</h3><p>创建新文件，在Core Data选项卡中选中Data Model</p>
<h3 id="3、创建实体（Entity）和属性（Attribute）">3、创建实体（Entity）和属性（Attribute）</h3><p>Add Entity，创建两个实体Photo、Photographer。分别Add Attribute，内容如下：</p>
<p>Photo</p>
<table>
<thead>
<tr>
<th>Attribute 1</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td>String</td>
</tr>
<tr>
<td>subTitle</td>
<td>String</td>
</tr>
<tr>
<td>photoURL</td>
<td>String</td>
</tr>
<tr>
<td>uploadDate</td>
<td>Date</td>
</tr>
<tr>
<td>thumbnailURL</td>
<td>String</td>
</tr>
<tr>
<td>thumbnailData</td>
<td>BinaryData</td>
</tr>
</tbody>
</table>
<p>Photographer</p>
<table>
<thead>
<tr>
<th>Attribute 1</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>String</td>
</tr>
</tbody>
</table>
<h3 id="4、建立Relationship">4、建立Relationship</h3><p>Edit Style切换至Graph（两个Style，左侧为Table，右侧为Graph），按着control键拖动任意一个Entity至另一个上。选中Photo，把newRelationship改名为whoTook；选中Photographer，把newRelationship改名为photos</p>
<h3 id="5、改变实体映射关系（一对一改为一对多）">5、改变实体映射关系（一对一改为一对多）</h3><p>选中Photographer中的photos这个Relationship，在右侧面板中，把Type改为To Many（如下图所示），表示Photographer实体对于Photo实体是一对多的关系。</p>
<p><img src="http://7xkfcm.com1.z0.glb.clouddn.com/CoreData-Relationship1.png" alt="image description"></p>
<blockquote>
<p>值得注意的是whoTook与photos也是有类型的：photos由于在此设置为To Many（一对多），因此是NSSet类型；whoTook由于是默认的To One（一对一），因此是指向NSManagedObject的指针。而NSManagedObject则是数据库中所有对象的超类。</p>
</blockquote>
<h3 id="6、删除规则">6、删除规则</h3><p>上图中右侧的Delete Rule，一共有四个选项，他们决定了当你删除对象时，实体间的关系会受到怎样的影响：</p>
<ul>
<li>如果关系的删除规则设定为Nullify（作废）。当A对象的关系指向的B对象被删除后，A对象的关系将被设为nil。对于To Many关系类型，B对象只会从A对象的关系的容器中被移除。</li>
<li>如果关系的删除规则为Cascade（级联），当B对象的关系指向的C对象被删除后，B对象也会被删除。B对象关联（以Cascade删除规则）的二级对象A也会被删除。以此类推。</li>
<li>如果关系的删除规则为Deny（拒绝），如果删除A对象时，A对象的关系指向的B对象仍存在，则删除操作会被拒绝。</li>
<li>如果关系的删除规则为NO Action，当A对象的关系指向的B对象被删除后，A对象保持不变，这意味着A对象的关系会指向一个不存在的对象。如果没有充分的理由，最好不要使用。</li>
</ul>
<h3 id="7、代码中如何使用">7、代码中如何使用</h3><p>你需要一个NSManagedObjectContext，无论在数据库中创建实体，设置对象属性，还是查询对象都需要这个context。如何获取这个context呢？有两种方式：</p>
<ol>
<li>创建UIManagedDocument对象，获取它的managedObjectContext（一个@property）</li>
<li>创建工程时勾选Use Core Data，这时你的AppDelegate会有一个managedObjectContext的@property（即在AppDelegate中 alloc init 一个NSManagedObjectContext对象），这种方式需要你对context的工作方式有一定了解，需要知道它如何保证线程安全等。而第一种方式UIManagedDocument对象已经帮我们把这些做好了。</li>
</ol>
<p>UIManagedDocument继承自UIDocument。UIDocument是一系列用于管理存储的机制，而UIManagedDocument把Core Data数据库放入某个特定存储空间，你可以把它看做本地数据库的容器。</p>
<h4 id="补充第7节的内容：使用苹果官网的做法所需的3个主要对象"><font style="color:red">补充第7节的内容：使用苹果官网的做法所需的3个主要对象</font></h4><p>视频中介绍的方式是通过UIManagedDocument对象来获取NSManagedObjectContext。也提到了“创建工程时勾选Use Core Data”的方式。其实第二种方式才是官网真正推荐的做法。当然第二种方式我们也可以不勾选Use Core Data，然后手动建立。</p>
<p>从官方文档<a href="https://developer.apple.com/library/prerelease/tvos/documentation/Cocoa/Conceptual/CoreData/InitializingtheCoreDataStack.html#//apple_ref/doc/uid/TP40001075-CH4-SW1" target="_blank" rel="external">Initializing the Core Data Stack</a>中可以看出，使用第二种方式，需要3个主要对象：</p>
<h5 id="（1）The_managed_object_context_(NSManagedObjectContext)：">（1）The managed object context (NSManagedObjectContext)：</h5><p>管理数据上下文，你可以将这一部分看作是数据的实际内容，这也是整个数据库中对我们而言最重要的部分，基本上，插入数据，查询数据，删除数据的工作都在这里完成。</p>
<p>管理数据上下文就像便笺簿。当从数据持久层获取数据时，相当于把这些临时的数据拷贝写在便笺簿上，然后就可以随心所欲的修改这些值。通过上下文，可以对数据记录NSManagedObject进行添加删除更改，记录更改后支持撤销和重做。<br><strong>除非你保存这些数据变化，否则持久层的东西是不会变化。</strong><br>通常我们将 controller 类或其子类与 NSManagedObjectContext绑定，这样就方便我们动态地生成，获取数据对象等。</p>
<p>NSManagedObjectContext常用的方法：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby"><span class="symbol">save:</span>将数据对象保存到数据文件</span><br><span class="line"></span>-<span class="ruby"><span class="symbol">objectWithID:</span>查询指定 <span class="constant">Managed</span> <span class="constant">Object</span> <span class="constant">ID</span> 的数据对象</span><br><span class="line"></span>-<span class="ruby"><span class="symbol">deleteObject:</span>将一个数据对象标记为删除，但是要等到 <span class="constant">Context</span> 提交更改时才真正删除数据对象</span><br><span class="line"></span>-<span class="ruby">undo回滚最后一步操作，这是都 undo/<span class="keyword">redo</span> 的支持</span><br><span class="line"></span>-<span class="ruby">lock加锁，常用于多线程以及创建事务。同类接口还有：-unlock <span class="keyword">and</span> -tryLock</span><br><span class="line"></span>-<span class="ruby">rollback还原数据文件内容</span><br><span class="line"></span>-<span class="ruby">reset清除缓存的 <span class="constant">Managed</span> <span class="constant">Objects</span>。只应当在添加或删除 <span class="constant">Persistent</span> <span class="constant">Stores</span> 时使用</span><br><span class="line"></span>-<span class="ruby">undoManager返回当前 <span class="constant">Context</span> 所使用的 <span class="constant">NSUndoManager</span></span><br><span class="line"></span>-<span class="ruby"><span class="symbol">assignObject:</span> <span class="symbol">toPersistantStore:</span>由于 <span class="constant">Context</span> 可以管理从不同数据文件而来的数据对象，</span><br><span class="line"></span>这个接口的作用就是指定数据对象的存储数据文件（通过指定 PersistantStore 实现）</span><br><span class="line">-<span class="ruby"><span class="symbol">executeFetchRequest:</span> <span class="symbol">error:</span>执行获取数据请求，返回所有匹配的数据对象</span></span><br></pre></td></tr></table></figure>
<h5 id="（2）_The_persistent_store_coordinator_(NSPersistentStoreCoordinator)：">（2） The persistent store coordinator (NSPersistentStoreCoordinator)：</h5><p>持久性数据协调器，你可以将这个东西看作是数据库连接器，在这里，你将设置数据存储的名字和位置，以及数据存储的时机。通常从磁盘上的数据文件中读取或存储数据，这些底层的读写就由它来处理。一般我们无需与它直接打交道，上下文已经封装了对它的调用<br>常用方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-<span class="string">addPersistentStoreForURL:</span><span class="string">configuration:</span><span class="string">URL:</span><span class="string">options:</span><span class="string">error:</span>加载持久化存储数据，对应的卸载接口为 -<span class="string">removePersistentStore:</span><span class="string">error:</span></span><br><span class="line">-<span class="string">migratePersistentStore:</span><span class="string">toURL:</span><span class="string">options:</span><span class="string">withType:</span><span class="string">error:</span>迁移数据存储，效果与 <span class="string">"save as"</span>相似，但是操作成功后，</span><br><span class="line">迁移前的数据存储不可再使用</span><br><span class="line">-<span class="string">managedObjectIDForURIRepresentation:</span>返回给定 URL所指示的数据存储的 object id，如果找不到匹配的数据存储则返回 nil</span><br><span class="line">-<span class="string">persistentStoreForURL:</span>返回指定路径的 Persistent Store</span><br><span class="line">-<span class="string">URLForPersistentStore:</span>返回指定 Persistent Store 的存储路径</span><br></pre></td></tr></table></figure>
<h5 id="（3）The_managed_object_model_(NSManagedObjectModel)：">（3）The managed object model (NSManagedObjectModel)：</h5><p>被管理的数据模型，用来描述程序的实体、其属性、关系的模型图，你可以将这个东西看作是数据库的轮廓，或者结构。这里包含了各个实体的定义信息，一般来说，你会使用XCode编辑器来操作那个.xcodedatamode文件，添加属性，建立属性之间的关系等等，当然你也可以使用代码。</p>
<p>数据模型包括以下几个部分：</p>
<h6 id="实体（Entity）">实体（Entity）</h6><p>对应NSEntityDescription对象，相当于数据库中的一个表。<br>NSEntityDescription 常用方法:</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+insertNewObjectForEntityForName:inManagedObjectContext: 工厂方法，</span><br><span class="line">根据给定的 Entity 描述，生成相应的 NSManagedObject 对象，并插入 ManagedObjectContext 中。</span><br><span class="line">-<span class="ruby">managedObjectClassName返回映射到 <span class="constant">Entity</span> 的 <span class="constant">NSManagedObject</span> 类名</span><br><span class="line"></span>-<span class="ruby">attributesByName以名字为 key， 返回 <span class="constant">Entity</span> 中对应的 <span class="constant">Attributes</span></span><br><span class="line"></span>-<span class="ruby">relationshipsByName以名字为 key， 返回 <span class="constant">Entity</span> 中对应的 <span class="constant">Relationships</span></span></span><br></pre></td></tr></table></figure>
<h6 id="属性（Property）">属性（Property）</h6><p>对应NSPropertyDescription对象。<br>Property 为 Entity 的特性，它相当于数据库表中的一列，或者 XML 文件中的 value-key 对中的 key。<br>它可以描述实体基本属性(Attribute)，实体之间的关系(RelationShip)，或查询属性(Fetched Property)。</p>
<ul>
<li>实体的基本属性（Attributes）：<br>对应NSAttributeDescription对象。存储基本数据，数据类型包括：<br>string，date，integer （NSString, NSDate, NSNumber）</li>
<li>实体间的关系（Relationships）：<br>对应NSRelationshipDescription对象。支持一对一、一对多的关系。</li>
<li>查询属性（Fetched Property）：对应NSFetchedPropertyDescription对象。<br>根据查询谓词返回指定实体的符合条件的数据对象，表示了一种“弱”的、单项的关系（相当于数据库中的查询语句）。</li>
</ul>
<blockquote>
<p>注意这里是NSManagedObjectModel，要区分一下NSManagedObject：</p>
<p>NSManagedObject是被管理的数据记录，相当于数据库中的一条记录。每一个NSManagedObject对象，都有一个全局ID（类型为：NSManagedObjectID）。每个在NSManagedObjectContext注册过的NSManagedObject，可以通过这个全局 ID 在上下文中查询到。<br>每个在持久存储层中的对象，都对应一个与上下文相关的NSManagedObject。<br>常用的方法：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">entity 获取实体</span><br><span class="line"></span>-<span class="ruby">objectID 获取<span class="constant">NSManagedObjectID</span></span><br><span class="line"></span>-<span class="ruby"><span class="symbol">valueForKey:</span> 获取指定 <span class="constant">Property</span> 的值</span><br><span class="line"></span>-<span class="ruby"><span class="symbol">setValue:</span> <span class="symbol">forKey:</span> 设定指定 <span class="constant">Property</span> 的值</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="8、创建UIManagedDocument对象">8、创建UIManagedDocument对象</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建UIManagedDocument对象</span></span><br><span class="line"><span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line"><span class="comment">//视频中NSDocumentationDirectory是不对的，应该是NSDocumentDirectory</span></span><br><span class="line"><span class="built_in">NSURL</span> *documentURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] firstObject];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> *documentName = <span class="string">@"MyDocument"</span>;</span><br><span class="line"><span class="built_in">NSURL</span> *fileURL = [documentURL URLByAppendingPathComponent:documentName];</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIManagedDocument</span> *document = [[<span class="built_in">UIManagedDocument</span> alloc] initWithFileURL:fileURL];</span><br></pre></td></tr></table></figure>
<h3 id="9、把UIManagedDocument对象创建在磁盘上并打开">9、把UIManagedDocument对象创建在磁盘上并打开</h3><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//检查文件是否存在</span><br><span class="line">    BOOL fileExist = <span class="keyword">[</span><span class="keyword">[</span>NSFileManager defaultManager] fileExistsAtPath:<span class="keyword">[</span>fileUR<span class="class">L path]];</span></span><br><span class="line">    </span><br><span class="line">    //如果存在，打开它</span><br><span class="line">   <span class="instruction"> if </span>(fileExist<span class="function">)</span> &#123;</span><br><span class="line">        <span class="keyword">[</span>document<span class="function"> openWithCompletionHandler:^(</span>BOOL success<span class="function">)</span> &#123;</span><br><span class="line">            //block to<span class="instruction"> execute </span>when open</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //如果不存在，创建文件</span><br><span class="line">    <span class="keyword">[</span>document saveToURL:fileURL forSaveOperation:UIDocumentSaveForCreating<span class="function"> completionHandler:^(</span>BOOL success<span class="function">)</span> &#123;</span><br><span class="line">        //block to<span class="instruction"> execute </span>when create is done</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
<h3 id="10、UIDocumentState">10、UIDocumentState</h3><p>UIManagedDocument创建完毕或者打开后，你才可以使用它。修改上面的代码如下：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  斯坦福公开课做法-使用UIManagedDocument管理Core Data</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import <span class="title">"ViewController.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photo.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photographer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">UIManagedDocument</span> *document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> createOrOpenDocumentWithName:<span class="string">@"MyDocument"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - 斯坦福公开课内容</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  创建或者打开数据库</span><br><span class="line"> **/</span></span><br><span class="line">- (<span class="keyword">void</span>)createOrOpenDocumentWithName:(<span class="built_in">NSString</span> *)documentName &#123;</span><br><span class="line">    <span class="comment">//创建UIManagedDocument对象</span></span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSURL</span> *documentURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] firstObject];</span><br><span class="line">    <span class="built_in">NSURL</span> *fileURL = [documentURL URLByAppendingPathComponent:documentName];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"fileURL :%@"</span>,fileURL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span><span class="variable">.document</span> = [[<span class="built_in">UIManagedDocument</span> alloc] initWithFileURL:fileURL];</span><br><span class="line">    <span class="comment">//检查文件是否存在</span></span><br><span class="line">    <span class="built_in">BOOL</span> fileExist = [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:[fileURL path]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果存在，打开它</span></span><br><span class="line">    <span class="keyword">if</span> (fileExist) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"文件存在，将要打开Document"</span>);</span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.document</span> openWithCompletionHandler:^(<span class="built_in">BOOL</span> success) &#123;</span><br><span class="line">            <span class="comment">//block to execute when open</span></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                [<span class="keyword">self</span> documentIsReady];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"couldn`t open document at %@"</span>,fileURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不存在，创建文件</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"文件不存在，将要创建Document"</span>);</span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.document</span> saveToURL:fileURL forSaveOperation:<span class="built_in">UIDocumentSaveForCreating</span> completionHandler:^(<span class="built_in">BOOL</span> success) &#123;</span><br><span class="line">            <span class="comment">//block to execute when create is done</span></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                [<span class="keyword">self</span> documentIsReady];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"couldn`t create document at %@"</span>,fileURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)documentIsReady &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.document</span><span class="variable">.documentState</span> == <span class="built_in">UIDocumentStateNormal</span>) &#123;</span><br><span class="line">        <span class="comment">//start using document</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>UIDocumentState对应的状态有：</p>
<ul>
<li>UIDocumentStateClosed (还没有打开或者创建)</li>
<li>UIDocumentStateSavingError (completion handler保存没有成功)</li>
<li>UIDocumentStateEditingDisabled (重试)</li>
<li>UIDocumentStateInConflict（例如有其他人在使用更新，有冲突到等，常见于使用ICloud时）</li>
</ul>
<p>执行完之后，查看你的打印输出，Finder中前往MyDocument所在位置，比如我的是：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/Users/</span>richfitbi<span class="regexp">/Library/</span>Developer<span class="regexp">/CoreSimulator/</span>Devices<span class="regexp">/512B2C87-F3C5-44D6-8D38-68CA86C3FD26/</span>data<span class="regexp">/Containers/</span>Data<span class="regexp">/Application/</span>C55410D2-<span class="number">7</span>D59-<span class="number">4</span>F48-B3A0-E2F0878E7124<span class="regexp">/</span></span><br></pre></td></tr></table></figure>
<p>可以看到MyDocument文件结构，并不是像我们想得那样生成sqlite文件，你无法直接查看数据。<br><img src="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataMyDocument@2x.png" alt="image description"></p>
<h3 id="11、获取NSManagedObjectContext对象">11、获取NSManagedObjectContext对象</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)documentIsReady &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.document</span><span class="variable">.documentState</span> == <span class="built_in">UIDocumentStateNormal</span>) &#123;</span><br><span class="line">        <span class="comment">//start using document</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获得context</span></span><br><span class="line">        <span class="built_in">NSManagedObjectContext</span> *context = <span class="keyword">self</span><span class="variable">.document</span><span class="variable">.managedObjectContext</span>;</span><br><span class="line">        <span class="comment">//操作core data......</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：</p>
<ul>
<li><p>UIManagedDocument是自动保存的。你可以手动保存，代码如下</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">[</span>self.document saveToURL:document.fileURL forSaveOperation:UIDocumentSaveForOverwriting<span class="function"> completionHandler:^(</span>BOOL success<span class="function">)</span> &#123;</span><br><span class="line">        //block to<span class="instruction"> execute </span>when save is done</span><br><span class="line">    &#125;];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>保存和创建时的代码几乎无差别，唯一不同的是UIDocumentSaveForOverwriting。该方法需要在主线程调用，且保存过程是异步的。一般我们会让UIManagedDocument自动保存，不会用到该方法。</p>
<ul>
<li><p>UIManagedDocument是自动关闭的。当没有任何强指针指向它时便会自动关闭。当然你也可以手动关闭，代码如下</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">[</span>self.document<span class="function"> closeWithCompletionHandler:^(</span>BOOL success<span class="function">)</span> &#123;</span><br><span class="line">    //block to<span class="instruction"> execute </span>when close</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>当然该方法也需要在主线程调用，且关闭过程同样是异步的。</p>
</blockquote>
<h3 id="12、UIManagedDocument多实例">12、UIManagedDocument多实例</h3><p>UIManagedDocument是可以有多实例的（尽管他们操作同一个数据库），每个实例都有自己的context，因此对一个UIManagedDocument实例进行操作不会影响另一个。如果同时对两个UIManagedDocument实例进行写入操作可能会产生冲突，但一般我们只会保留一个实例能够写入，其它只读。那么其中一个实例如何知道另一个实例进行了修改呢？这就需要用到NSNotiFication广播站。</p>
<ul>
<li>如何注册一个广播？</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">-</span> (void)<span class="tag">viewDidAppear</span>:(BOOL)<span class="tag">animated</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr_selector">[super viewDidAppear:animated]</span>;</span><br><span class="line">   <span class="attr_selector">[center addObserver:self</span><br><span class="line">              selector:@selector(contextChanged:)</span><br><span class="line">                  name:NSManagedObjectContextDidSaveNotification</span><br><span class="line">                object:document.managedObjectContext]</span>; <span class="comment">// don’t pass nil here!</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">-</span> (void)<span class="tag">viewWillDisappear</span>:(BOOL)<span class="tag">animated</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr_selector">[center removeObserver:self</span><br><span class="line">                      name:NSManagedObjectContextDidSaveNotification</span><br><span class="line">                    object:document.managedObjectContext]</span>;</span><br><span class="line">    <span class="attr_selector">[super viewWillDisappear:animated]</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>广播得到消息之后能做什么？如何在contextChanged里操作？</li>
</ul>
<p>（1）可以取回我的所有对象</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)contextChanged:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//  notification.userInfo 返回给我们的是一个字典包含以下的key</span></span><br><span class="line">    <span class="built_in">NSInsertedObjectsKey</span> <span class="comment">//插入的对象数组</span></span><br><span class="line">    <span class="built_in">NSUpdatedObjectsKey</span> <span class="comment">// 有属性更改的对象数组</span></span><br><span class="line">    <span class="built_in">NSDeletedObjectsKey</span> <span class="comment">// 有删除的对象数组</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）Merging changes:使用NSManagedObjectContext的方法，只要把notification传给它，它会自动帮我们把所有的变化合并到我们的context中</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">-</span> (<span class="tag">void</span>)<span class="rule"><span class="attribute">mergeChangesFromContextDidSaveNotification</span>:<span class="value">(NSNotification *)notification</span></span>;</span><br></pre></td></tr></table></figure>
<h4 id="补充8、9、10、11、12节内容：初始化Core_Data上下文环境"><font style="color:red">补充8、9、10、11、12节内容：初始化Core Data上下文环境</font></h4><p>前文补充第7节的内容提到使用苹果官网的做法所需的3个主要对象，按照这种做法，8、9、10、11、12节内容基本用不上了。</p>
<p>官方文档这个步骤名字叫做<a href="https://developer.apple.com/library/prerelease/tvos/documentation/Cocoa/Conceptual/CoreData/InitializingtheCoreDataStack.html#//apple_ref/doc/uid/TP40001075-CH4-SW1" target="_blank" rel="external">Initializing the Core Data Stack</a>，直译过来就是“初始化Core Data堆栈”，不太好理解，参考<a href="http://blog.csdn.net/q199109106q/article/details/8563438/" target="_blank" rel="external">MJ大神的博客</a>，这个步骤叫做“初始化Core Data上下文环境”更加贴切。</p>
<p>我们先设置下XCode的运行方案（Edit Scheme），使XCode可以输出SQL语句。这样我们可以更加清楚的看到Core Data实际做了什么事情。</p>
<h4 id="设置XCode运行时输出SQL语句：">设置XCode运行时输出SQL语句：</h4><p>Product -&gt; Scheme —&gt;Edit Scheme，打开的面板选中左侧Run，右侧顶部选中Arguments标签，添加下面的语句<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-com<span class="class">.apple</span><span class="class">.CoreData</span><span class="class">.SQLDebug</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></p>
<p>如图所示：</p>
<p><img src="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataSQLDebugArguments@2x.png" alt="image description"></p>
<h4 id="初始化Core_Data上下文环境">初始化Core Data上下文环境</h4><p>先说明一下，以下代码并不是标准做法（通常这些操作会放在AppDelegate中），但基本思路大致相同。详细内容都已添加注释，大家直接看代码好了。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  苹果官网做法-使用三打核心对象管理Core Data</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import <span class="title">"ViewController2.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photo.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photographer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController2</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSManagedObjectContext</span> *managedObjectContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController2</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    [<span class="keyword">self</span> initializeCoreData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - 苹果官网做法 Initializing the Core Data Stack</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setManagedObjectContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_managedObjectContext) &#123;</span><br><span class="line">        _managedObjectContext = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initializeCoreData</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.xcdatamodel文件，编译后为.momd文件</span></span><br><span class="line">    <span class="built_in">NSURL</span> *modelURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"Model"</span> withExtension:<span class="string">@"momd"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"modelURL : %@"</span>,modelURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectModel</span></span><br><span class="line">    <span class="built_in">NSManagedObjectModel</span> *mom = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</span><br><span class="line">    <span class="built_in">NSAssert</span>(mom != <span class="literal">nil</span>, <span class="string">@"Error initializing Managed Object Model"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSPersistentStoreCoordinator</span></span><br><span class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *psc = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:mom];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectContext</span></span><br><span class="line">    <span class="comment">//initWithConcurrencyType: 初始化，以明确你是使用基于队列的并发模型</span></span><br><span class="line">    <span class="built_in">NSManagedObjectContext</span> *moc = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:<span class="built_in">NSMainQueueConcurrencyType</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//NSManagedObjectContext与NSPersistentStoreCoordinator相关联</span></span><br><span class="line">    [moc setPersistentStoreCoordinator:psc];</span><br><span class="line">    [<span class="keyword">self</span> setManagedObjectContext:moc];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSURL</span> *documentsURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] lastObject];</span><br><span class="line">    <span class="built_in">NSURL</span> *storeURL = [documentsURL URLByAppendingPathComponent:<span class="string">@"Model.sqlite"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"storeURL :%@"</span>,storeURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置NSManagedObjectContext的NSPersistentStoreCoordinator，使之与本地存储文件相关联。</span></span><br><span class="line">    <span class="comment">//这样设置之后，就无需管理本地存储，一切交由NSManagedObjectContext来处理。</span></span><br><span class="line">    <span class="comment">//无需像视频中讲解的那样，需要检查数据库文件是否存在，需要判断数据库文件是否已打开。</span></span><br><span class="line">    <span class="built_in">NSError</span>* error;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.managedObjectContext</span><span class="variable">.persistentStoreCoordinator</span> addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:<span class="literal">nil</span> error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error: %@"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>第一次运行，我们能看到如下输出：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">CoreData: annotation: Connecting to sqlite database file at "/Users/richfitbi/Library/Developer/CoreSimulator/Devices/512B2C87-F3C5-44D6-8D38-68CA86C3FD26/data/Containers/Data/Application/9A8ED91D-1C3C-432C-AFB6-4B970B2E555D/Documents/Model.sqlite"</span><br><span class="line">CoreData: annotation: creating schema.</span><br><span class="line">CoreData: sql: <span class="operator"><span class="keyword">pragma</span> page_size=<span class="number">4096</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> auto_vacuum=<span class="number">2</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">BEGIN</span> EXCLUSIVE</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_METADATA'</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ZPHOTO ( Z_PK <span class="built_in">INTEGER</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, Z_ENT <span class="built_in">INTEGER</span>, Z_OPT <span class="built_in">INTEGER</span>, ZWHOTOOK <span class="built_in">INTEGER</span>, ZUPLOADDATE <span class="keyword">TIMESTAMP</span>, ZPHOTOURL <span class="built_in">VARCHAR</span>, ZSUBTITLE <span class="built_in">VARCHAR</span>, ZTHUMBNAILURL <span class="built_in">VARCHAR</span>, ZTITLE <span class="built_in">VARCHAR</span>, ZUNIQUE <span class="built_in">VARCHAR</span>, ZTHUMBNAILDATA <span class="built_in">BLOB</span> ) </span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ZPHOTOGRAPHER ( Z_PK <span class="built_in">INTEGER</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, Z_ENT <span class="built_in">INTEGER</span>, Z_OPT <span class="built_in">INTEGER</span>, ZNAME <span class="built_in">VARCHAR</span> ) </span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ZPHOTO_ZWHOTOOK_INDEX <span class="keyword">ON</span> ZPHOTO (ZWHOTOOK)</span><br><span class="line">CoreData: annotation: Creating <span class="keyword">primary</span> <span class="keyword">key</span> <span class="keyword">table</span>.</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Z_PRIMARYKEY (Z_ENT <span class="built_in">INTEGER</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, Z_NAME <span class="built_in">VARCHAR</span>, Z_SUPER <span class="built_in">INTEGER</span>, Z_MAX <span class="built_in">INTEGER</span>)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> Z_PRIMARYKEY(Z_ENT, Z_NAME, Z_SUPER, Z_MAX) <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">'Photo'</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> Z_PRIMARYKEY(Z_ENT, Z_NAME, Z_SUPER, Z_MAX) <span class="keyword">VALUES</span>(<span class="number">2</span>, <span class="string">'Photographer'</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Z_METADATA (Z_VERSION <span class="built_in">INTEGER</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>, Z_UUID <span class="built_in">VARCHAR</span>(<span class="number">255</span>), Z_PLIST <span class="built_in">BLOB</span>)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_METADATA'</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">DELETE</span> <span class="keyword">FROM</span> Z_METADATA <span class="keyword">WHERE</span> Z_VERSION = ?</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> Z_METADATA (Z_VERSION, Z_UUID, Z_PLIST) <span class="keyword">VALUES</span> (?, ?, ?)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_MODELCACHE'</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Z_MODELCACHE (Z_CONTENT <span class="built_in">BLOB</span>)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> Z_MODELCACHE (Z_CONTENT) <span class="keyword">VALUES</span> (?)</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">COMMIT</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> journal_mode=wal</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> journal_mode=wal</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> cache_size=<span class="number">200</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> Z_VERSION, Z_UUID, Z_PLIST <span class="keyword">FROM</span> Z_METADATA</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_MODELCACHE'</span></span></span><br></pre></td></tr></table></figure>
<p>第二次运行，我们能看到如下输出：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CoreData: annotation: Connecting to sqlite database file at "/Users/richfitbi/Library/Developer/CoreSimulator/Devices/512B2C87-F3C5-44D6-8D38-68CA86C3FD26/data/Containers/Data/Application/F00EE1CA-3AC0-4673-B1E4-1A16EF776A1D/Documents/Model.sqlite"</span><br><span class="line">CoreData: sql: <span class="operator"><span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_METADATA'</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> journal_mode=wal</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">pragma</span> cache_size=<span class="number">200</span></span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> Z_VERSION, Z_UUID, Z_PLIST <span class="keyword">FROM</span> Z_METADATA</span><br><span class="line">CoreData: <span class="keyword">sql</span>: <span class="keyword">SELECT</span> TBL_NAME <span class="keyword">FROM</span> SQLITE_MASTER <span class="keyword">WHERE</span> TBL_NAME = <span class="string">'Z_MODELCACHE'</span></span></span><br></pre></td></tr></table></figure>
<p>对比两次运行结果，可以看出第一次比第二次多出了许多创建表的逻辑。而你的代码中仅仅创建NSManagedObjectModel、NSPersistentStoreCoordinator、NSManagedObjectContext，并设置了他们之间的关系，无需判断本地数据库文件是否存在，无需判断数据库是否已经打开，这些Core Data都帮你做好了。</p>
<p>执行完之后，查看你的打印输出，Finder中前往sqlite文件位置，可以看到如下结构：</p>
<p><img src="http://7xkfcm.com1.z0.glb.clouddn.com/CoreDataSqliteFile@2x.png" alt="image description"></p>
<h3 id="13、插入操作">13、插入操作</h3><h4 id="（1）往数据库中插入对象">（1）往数据库中插入对象</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSManagedObject *photo = [NSEntityDescription <span class="string">insertNewObjectForEntityForName:</span>@<span class="string">"Photo"</span> <span class="string">inManagedObjectContext:</span>context];</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>别忘记<code>#import &lt;CoreData/CoreData.h&gt;</code>。</li>
<li>NSManagedObject实例对应了Core Data Model中的Entity。</li>
<li>新插入的对象所有属性都为nil，除非你在XCode中为属性指定了默认值。</li>
</ul>
</blockquote>
<h4 id="（2）获取和设置属性">（2）获取和设置属性</h4><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- <span class="comment">(id)</span>valueForKey:<span class="comment">(NSString *)</span>key; </span><br><span class="line">- <span class="comment">(void)</span>setValue:<span class="comment">(id)</span>value forKey:<span class="comment">(NSString *)</span>key; </span><br><span class="line"><span class="comment">//或者也可以用：valueForKeyPath:/setValue:forKeyPath</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里key是你在XCode中创建数据映射时的Attribute name。如”thumbnailURL”、”title”。</li>
<li>value则是你已经存储或将要存储到数据库中的值。未存储之前，所有的value都是nil，除非你在XCode中为它指定了默认值。所有value都是object：<ul>
<li>number和booleans values是 NSNumber 对象</li>
<li>Binary data values是 NSData 对象</li>
<li>Date values是 NSDate 对象</li>
<li>“To-many” mapped relationship是 NSSet 对象（如果指定排序则是NSOrderedSet 对象）</li>
<li>“To-one” mapped relationship是 NSManagedObject 对象</li>
</ul>
</li>
<li>对于有关联关系的实体，只用设置一侧，另一侧会自动设置。</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NSManagedObject *photo = [NSEntityDescription <span class="string">insertNewObjectForEntityForName:</span>@<span class="string">"Photo"</span> <span class="string">inManagedObjectContext:</span>context];</span><br><span class="line"> </span><br><span class="line">NSManagedObject *photographer = [NSEntityDescription <span class="string">insertNewObjectForEntityForName:</span>@<span class="string">"Photographer"</span> <span class="string">inManagedObjectContext:</span>context];</span><br><span class="line">   </span><br><span class="line">[photographer <span class="string">setValue:</span>@<span class="string">"LYL"</span> <span class="string">forKey:</span>@<span class="string">"name"</span>];</span><br><span class="line">[photo <span class="string">setValue:</span>@<span class="string">"My Picture"</span> <span class="string">forKey:</span>@<span class="string">"title"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//当设置完photo中的relationship之后，photographer的photos 集合会自动添加，无需两边同时设置。</span></span><br><span class="line">[photo <span class="string">setValue:</span>photographer <span class="string">forKey:</span>@<span class="string">"whoTook"</span>];</span><br></pre></td></tr></table></figure>
<h4 id="（3）保存到磁盘">（3）保存到磁盘</h4><p>以上（1）、（2）的内容都是在内存中进行的，当做完这些之后，需要保存到磁盘。前面已经提过，UIManagedDocument是自动保存的，所以此时你什么也不需要做，只是知道有这个过程就可以了。</p>
<p>当UIManagedDocument自动保存后，<code>UIManageredDocumentDidSaveNotification</code>将会广播。</p>
<blockquote>
<p>注意在开发过程中，一旦你点击了XCode中的”Stop”，自动保存的过程可能会错过。</p>
</blockquote>
<h3 id="14、生成实体的子类">14、生成实体的子类</h3><p>你一定觉得上面的代码很糟糕，<code>setValue:forKey</code>的方式没有类型检查，没有代码提示，一旦后期维护时修改了实体中的属性名，你都无法找到代码中哪里需要修改。所以我们需要创建实体的子类。</p>
<p>选中Model.xcdatamodeld中的任意一个Entities， Editor-&gt;Create NSManagedObject Subclass，按照提示完成后续步骤。</p>
<blockquote>
<p>注1：实体的子类的命名，官方推荐用MO作为后缀。</p>
<p><img src="https://developer.apple.com/library/prerelease/tvos/documentation/Cocoa/Conceptual/CoreData/Art/Entity_Inspector_2x.png" alt="image description"></p>
<p>注2：如果你使用iOS8之上的SDK，会发现生成的文件和视频中的不一样，多了4个后缀为CoreDataProperties的 Category，请放心，内容还是一样的，只不过实现了代码分离，更多代码放入Category而已。</p>
</blockquote>
<p>生成实体的子类后，我们的代码可以这么写，看上去是不是舒服多了？</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Photo *<span class="variable">photo2 =</span> [NSEntityDescription insertNewObjectForEntityForName:@<span class="string">"Photo"</span> inManagedObjectContext:context];</span><br><span class="line">  </span><br><span class="line">Photographer *<span class="variable">photographer2 =</span> [NSEntityDescription insertNewObjectForEntityForName:@<span class="string">"Photographer"</span> inManagedObjectContext:context];</span><br><span class="line"></span><br><span class="line">photographer2.<span class="variable">name =</span> @<span class="string">"YYC"</span>;</span><br><span class="line">photo2.<span class="variable">title =</span> @<span class="string">"YYC`s picture"</span>;</span><br><span class="line">photo2.<span class="variable">whoTook =</span> photographer2;</span><br></pre></td></tr></table></figure>
<p>再来看看使用XCode我们生成的这些类。我们把精力放在后缀为 CoreDataProperties 的 Category上面，会发现一些共性：</p>
<h4 id="（1）@dynamic">（1）@dynamic</h4><p>在.h文件中声明的@Property，在.m文件中用@dynamic来实现。</p>
<blockquote>
<p>@dynamic</p>
<p>You use the@dynamic keyword to tell the compiler that you will fulfill the API contract implied by a property either by providing method implementations directly or at runtime using other mechanisms such as dynamic loading of code or dynamic method resolution. It suppresses the warnings that the compiler would otherwise generate if it can”t find suitable implementations. You should only use it if you know that the methods will be available at runtime.</p>
<p>　　The example shown in Listing 5-3 illustrates using @dynamic with a subclass of NSManagedObject.</p>
<p>　　Listing 5-3 Using @dynamic with NSManagedObject</p>
<p>　　@interface MyClass : NSManagedObject</p>
<p>　　{</p>
<p>　　}</p>
<p>　　@property(nonatomic, retain) NSString *value;</p>
<p>　　@end</p>
<p>　　@implementation MyClass</p>
<p>　　@dynamic value;</p>
<p>　　@end</p>
<p>　　NSManagedObject is provided by the Core Data framework. A managed object class has a corresponding schema that defines attributes and relationships for the class; at runtime, the Core Data framework generates accessor methods for these as necessary. You therefore typically declare properties for the attributes and relationships, but you don”t have to implement the accessor methods yourself, and shouldn”t ask the compiler to do so. If you just declared the property without providing any implementation, however, the compiler would generate a warning. Using @dynamic suppresses the warning.</p>
<p>@dynamic 就是要来告诉编译器，代码中用@dynamic修饰的属性，其getter和setter方法会在程序运行的时候或者用其他方式动态绑定，以便让编译器通过编译。其主要的作用就是用在NSManageObject对象的属性声明上，由于此类对象的属性一般是从Core Data的属性中生成的，Core Data框架会在程序运行的时候为此类属性生成getter和Setter方法。</p>
<p>@dynamic这个关键词，在其它地方通常是用不到的。</p>
<p>它与@synthesize的区别在于：</p>
<p>使用@synthesize，编译器会确实的产生getter和setter方法，而@dynamic仅仅是告诉编译器这两个方法在运行期会有的，无需产生警告。</p>
<p>假设有这么个场景，B类，C类分别继承A类，A类实现某个协议（@protocol），协议中某个属性( somePropety )我不想在A中实现，而在B类，C类中分别实现。如果A中不写任何代码，编译器就会给出警告：</p>
<p>“use @synthesize, @dynamic or provide a method implementation”</p>
<p>这时你给用@dynamic somePropety; 编译器就不会警告，同时也不会产生任何默认代码。</p>
<p>这段引用内容摘自<a href="http://blog.csdn.net/kingkong1024/article/details/8588068" target="_blank" rel="external">这里</a></p>
</blockquote>
<p>使用@dynamic只是告诉编译器“我在此处无需实现get/set方法，我知道自己要做什么，不用给我警告”。那它到底做了什么呢？其实很简单，我们上面代码也已经用过了：在运行时NSManagedObject会对识别不到的选择器（@property在运行时其实是调用get/set方法），会尝试调用<code>value:forKey</code>，<code>setValue:forKey</code>方法，因此此处无需实现get/set方法。</p>
<h4 id="（2）CoreDataGeneratedAccessors">（2）CoreDataGeneratedAccessors</h4><p>具有一对多关系的实体，“一”那一方（如本例中的PhotoGrapher），会在.h文件中多出一个CoreDataGeneratedAccessors的Category，并提供了一些针对NSSet集合进行操作的方法。</p>
<h4 id="（3）我们要手动往实体的子类中添加代码，应该使用Category。">（3）我们要手动往实体的子类中添加代码，应该使用Category。</h4><p>这是因为在版本迭代过程中，我们可能经常需要recreate这些实体，我们不希望每次recreate之后，都要重新修改里面的所有方法。所以最好用Category将你自己的代码独立出来。一个经典的例子是：如果我们希望某个实体可以有方法把自己的示例添加到数据库（这在Java Hibernate中很常见吧），最好的做法就是使用Category。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@implementation</span> Photo (Create)</span><br><span class="line"></span><br><span class="line">+ (Photo *)<span class="string">photoWithFlickerData:</span>(NSDictionary *)flickerData <span class="string">inManagedObjectContext:</span>(NSManagedObjectContext *)context</span><br><span class="line">&#123;</span><br><span class="line">   Photo *photo = ...; <span class="comment">// 查看photo是否存在</span></span><br><span class="line">   <span class="keyword">if</span> (!photo) &#123;</span><br><span class="line">      photo = [NSEntityDescription <span class="string">insertNewObjectForEntityForName:</span>@<span class="string">"Photo"</span> <span class="string">inManagedObjectContext:</span>context];</span><br><span class="line">      <span class="comment">//.....</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> photo;</span><br><span class="line">&#125;</span><br><span class="line"><span class="annotation">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意Category不能创建新的实例变量，也不能使用原类中的实例变量，但原类中可以通过@property的方式把自己的实例变量公共话， Category是可以使用原类中的属性的。</p>
</blockquote>
<h4 id="补充13、14节内容：使用苹果官网做法往数据库中插入数据"><font style="color:red">补充13、14节内容：使用苹果官网做法往数据库中插入数据</font></h4><p>插入操作，和公开课中讲得代码只有一处不同：</p>
<p>公开课中的方式无需手动保存数据到数据库，UIManagedDocument是自动保存的。</p>
<p>而<strong>苹果官网做法，要保存数据到本地数据库，必须要执行 NSManagedObjectContext 的 save 操作</strong>。</p>
<blockquote>
<p>The creation of NSManagedObject instances does not guarantee their persistence. Once you create an NSManagedObject instance in your managed object context, you must explicitly save that context to persist those changes to your persistent store</p>
</blockquote>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">Photo <span class="subst">*</span>photo <span class="subst">=</span> <span class="attribute">...</span></span><br><span class="line">Photographer <span class="subst">*</span>photographer <span class="subst">=</span> <span class="attribute">...</span>    </span><br><span class="line">photo<span class="built_in">.</span>title<span class="subst">=</span><span class="attribute">...</span></span><br><span class="line">photo<span class="built_in">.</span>whoTook <span class="subst">=</span>  photographer;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="comment">//此时进行查询，可以查询出数据，但并没有保存到本地数据库文件。</span></span><br><span class="line"><span class="comment">//[self fetchPhotoData];</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line"><span class="preprocessor">[</span><span class="built_in">self</span> saveManagedObjectContext<span class="preprocessor">]</span><span class="markup">;</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">- (<span class="keyword">void</span>)saveManagedObjectContext &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> success = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> save:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="string">@"同步数据至数据库时发生错误"</span> format:<span class="string">@"%@"</span>, [error localizedDescription]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="15、删除操作">15、删除操作</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[context deleteObject:photo]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意不是马上删除，而是在之后的某个时刻UIManagedDocument会自动删除。</p>
<p>在这行代码之后，要删除掉所有指向photo的强指针。并且把photo置为nil。</p>
</blockquote>
<p>删除操作有一点很酷，当发送<code>deleteObject</code>消息后，Core Data会给所有对象发送<code>prepareForDeletion</code>消息。通常会把这个方法放入Category中。这个方法会在将要删除但还没有删除时发生。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@implementation</span> Photo (Deletion)</span><br><span class="line">- (void)prepareForDeletion &#123;</span><br><span class="line"><span class="comment">//我们不需要在此处设置whoTool为nil等（会自动执行）</span></span><br><span class="line"><span class="comment">//但假如Photographer有个property叫photocount，表示拍照者拍了多少张照片，可以在此调整。</span></span><br><span class="line"><span class="comment">//比如self.whoTook.photocount--;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>课程中并没有讲解更新操作，这是因为从代码上看来，更新操作就是更新下某个对象的属性而已：</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSArray *resultList = [context executeFetchRequest:request <span class="keyword">error</span>:&amp;<span class="keyword">error</span>];</span><br><span class="line">    <span class="keyword">if</span> (resultList &amp;&amp; resultList.<span class="keyword">count</span> &gt; 0) &#123;</span><br><span class="line">        Photo *photo = resultList[0];</span><br><span class="line">        <span class="comment">//更新操作，在代码上看，只是修改下对象的相关属性。</span></span><br><span class="line">        photo.title = @<span class="string">"YYC`s picture2222"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="补充15节内容：使用苹果官网做法往数据库中更新、删除数据"><font style="color:red">补充15节内容：使用苹果官网做法往数据库中更新、删除数据</font></h4><p>和插入操作类似，对于更新、删除炒作，按照苹果官网做法，要保存数据到本地数据库，必须要执行 NSManagedObjectContext 的 save 操作。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//更新Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)updatePhotoData &#123;</span><br><span class="line">    <span class="comment">//先找到要更新的内容</span></span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = ...;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = ...;</span><br><span class="line">    Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">//更新操作，在代码上看，只是修改下对象的相关属性。</span></span><br><span class="line">    photo<span class="variable">.title</span> = ...;</span><br><span class="line">    <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">    [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)deletePhotoData &#123;</span><br><span class="line">    <span class="comment">//先找到要删除的内容</span></span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = ...;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = ...;</span><br><span class="line">    Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> deleteObject:photo];</span><br><span class="line">    <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">    [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//saveManagedObjectContext方法见第14节</span></span><br></pre></td></tr></table></figure>
<h3 id="16、查询操作">16、查询操作</h3><h4 id="第一步：创建NSFetchRequest">第一步：创建NSFetchRequest</h4><p>（1）指定要取回的实体。</p>
<p>使用NSFetchRequest取回的数据是一个数组，且数组中都是同一种实体的数据，不可能是一部分Photo，一部分Photographer。</p>
<p>（2）指定每批可以取回多少数据，或者最多可以取回多少数据（可选，默认是all）。</p>
<p>（3）使用NSSortDescriptors来对取回的数据数组进行排序。</p>
<p>（4）NSPredicate谓词，限定哪些实体可以被取回（可选，默认是all）。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSFetchRequest *<span class="variable">request =</span> [NSFetchRequest fetchRequestWithEntityName:@<span class="string">"Photo"</span>];</span><br><span class="line">request.<span class="variable">fetchBatchSize =</span> <span class="number">20</span>; //每次只会取<span class="number">20</span>调数据</span><br><span class="line">request.<span class="variable">fetchLimit =</span> <span class="number">100</span>;//原本有<span class="number">1000</span>条数据，取到<span class="number">100</span>条就结束，不会再往下取</span><br><span class="line">request.<span class="variable">sortDescriptors =</span> @[sortDescriptor];</span><br><span class="line">request.<span class="variable">predicate =</span> ...;</span><br></pre></td></tr></table></figure>
<h5 id="NSSortDescriptors">NSSortDescriptors</h5><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSSortDescriptor *sortDescriptor = [NSSortDescriptor <span class="string">sortDescriptorWithKey:</span>@<span class="string">"title"</span> <span class="string">ascending:</span>YES  <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">localizedStandardCompare:</span>)];</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSSortDescriptor</span> *descriptor2 = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"title"</span> ascending:<span class="literal">YES</span> comparator:^<span class="built_in">NSComparisonResult</span>(<span class="keyword">id</span>  _Nonnull obj1, <span class="keyword">id</span>  _Nonnull obj2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">NSOrderedSame</span>;</span><br><span class="line">            <span class="comment">//NSOrderedAscending= -1L, NSOrderedSame, NSOrderedDescending</span></span><br><span class="line">        &#125; ];</span><br></pre></td></tr></table></figure>
<p>第一个参数，表示按什么排序。</p>
<p>第二个参数，ascending 升序。</p>
<p>第三个参数，附加对比规则。比如两个Photo，title相同，它们在数组中如何决定顺序呢，这就用到附加对比规则了。其中<code>localizedStandardCompare:</code>是一个内置选择器，它将根据当前语言环境的语言规则进行排序（语言环境可能会根据大小写，变音符号等等的顺序而发生改变。等同于Finder中的排序规则。</p>
<blockquote>
<p>更多内容可以参考<a href="http://nshipster.cn/nssortdescriptor/" target="_blank" rel="external">这篇文章</a></p>
</blockquote>
<h5 id="NSPredicate">NSPredicate</h5><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *serverName = <span class="string">@"flickr-5"</span>;</span><br><span class="line">        <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"thumbnailURL containers %@"</span>,serverName];</span><br></pre></td></tr></table></figure>
<blockquote>
<p>更多内容可以参考<a href="http://nshipster.cn/nspredicate/" target="_blank" rel="external">这篇文章</a></p>
</blockquote>
<h5 id="高级查询">高级查询</h5><ul>
<li><p>Key Value Coding（键值编码）<br>利用键值编码的高级用法，如<code>photos.@count &gt; 5</code>可以进行高级查询，当然还是要结合NSPredicate来完成。类似<code>@count</code>这样的函数，左侧总是dictionary、array、set。更多内容请参考<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/KeyValueCoding/Articles/CollectionOperators.html" target="_blank" rel="external">官方文档</a></p>
</li>
<li><p>NSExpression</p>
</li>
</ul>
<h4 id="第二步：执行NSFetchRequest">第二步：执行NSFetchRequest</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">NSError</span> *<span class="built_in">error</span>;</span><br><span class="line"></span><br><span class="line"><span class="title">NSArray</span> *resultList = [context executeFetchRequest:request <span class="built_in">error</span>:&amp;<span class="built_in">error</span>];</span><br></pre></td></tr></table></figure>
<p>一定注意：</p>
<ul>
<li>发生错误时，resultList为nil</li>
<li>未查询出结果，返回结果是空数组，不是nil</li>
</ul>
<h4 id="补充16节内容：使用苹果官网做法查询数据"><font style="color:red">补充16节内容：使用苹果官网做法查询数据</font></h4><p>和课程中所讲方式无区别。</p>
<h3 id="17、关于性能">17、关于性能</h3><p>如果你想获取10000条数据，你得不到这真正的10000条数据，你只会得到10000个占位符。只有当你需要展开某条数据时，才真正得到这条数据。比如</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Photographer *photographer <span class="keyword">in</span> photographers) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"fetched photographer %@"</span>, photographer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时你看不到photographer的names，你也许只能看到”unfaulted object”。但下面的情况：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Photographer *photographer <span class="keyword">in</span> photographers) &#123;</span><br><span class="line">    NSLog(@<span class="string">"fetched photographer %@"</span>, photographer.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于在NSLog中需要展开photographer，此时你才能真正的从数据库获取他们。</p>
<h3 id="18、关于线程">18、关于线程</h3><blockquote>
<p>此处简要提及，没有细讲，我会在后续文章中补充。</p>
</blockquote>
<ul>
<li>NSManagedObjectContext并不是线程安全的。</li>
<li>Thread-Safe Access to an NSManagedObjectContext</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[context <span class="attribute">performBlock</span>:^&#123; <span class="pi">//or performBlockAndWait:</span><br><span class="line"> //</span><span class="keyword">do</span> stuff <span class="keyword">with</span> context <span class="keyword">in</span> its safe queue(the queue <span class="literal">it</span> was created <span class="literal">on</span>)</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<h3 id="19、课程提到但没讲的内容">19、课程提到但没讲的内容</h3><blockquote>
<p>我会在后续文章中补充。</p>
</blockquote>
<ul>
<li>Parent Context (advanced)</li>
<li>Optimistic locking (deleteConflictsForObject)</li>
<li>Rolling back unsaved changes</li>
<li>Undo/Redo</li>
<li>Staleness (how long after a fetch until a refetch of an object is required? )不刷新时间，也就是取回数据要待多长时间而不被刷新，一定时间后，需要重新取回。</li>
</ul>
<h3 id="20、完整代码">20、完整代码</h3><p>代码仅仅是为了大家理解，请忽略代码质量 ：）</p>
<h4 id="斯坦福公开课做法-使用UIManagedDocument管理Core_Data">斯坦福公开课做法-使用UIManagedDocument管理Core Data</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">"ViewController.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photo.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photographer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">UIManagedDocument</span> *document;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> createOrOpenDocumentWithName:<span class="string">@"MyDocument"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - 斯坦福公开课内容</span></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  创建或者打开数据库</span><br><span class="line"> **/</span></span><br><span class="line">- (<span class="keyword">void</span>)createOrOpenDocumentWithName:(<span class="built_in">NSString</span> *)documentName &#123;</span><br><span class="line">    <span class="comment">//创建UIManagedDocument对象</span></span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSURL</span> *documentURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] firstObject];</span><br><span class="line">    <span class="built_in">NSURL</span> *fileURL = [documentURL URLByAppendingPathComponent:documentName];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"fileURL :%@"</span>,fileURL);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span><span class="variable">.document</span> = [[<span class="built_in">UIManagedDocument</span> alloc] initWithFileURL:fileURL];</span><br><span class="line">    <span class="comment">//检查文件是否存在</span></span><br><span class="line">    <span class="built_in">BOOL</span> fileExist = [[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:[fileURL path]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果存在，打开它</span></span><br><span class="line">    <span class="keyword">if</span> (fileExist) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"文件存在，将要打开Document"</span>);</span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.document</span> openWithCompletionHandler:^(<span class="built_in">BOOL</span> success) &#123;</span><br><span class="line">            <span class="comment">//block to execute when open</span></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                [<span class="keyword">self</span> documentIsReady];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"couldn`t open document at %@"</span>,fileURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果不存在，创建文件</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"文件不存在，将要创建Document"</span>);</span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.document</span> saveToURL:fileURL forSaveOperation:<span class="built_in">UIDocumentSaveForCreating</span> completionHandler:^(<span class="built_in">BOOL</span> success) &#123;</span><br><span class="line">            <span class="comment">//block to execute when create is done</span></span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                [<span class="keyword">self</span> documentIsReady];</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"couldn`t create document at %@"</span>,fileURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)documentIsReady &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.document</span><span class="variable">.documentState</span> == <span class="built_in">UIDocumentStateNormal</span>) &#123;</span><br><span class="line">        <span class="comment">//start using document</span></span><br><span class="line">        <span class="comment">//获得context</span></span><br><span class="line">        <span class="built_in">NSManagedObjectContext</span> *context = <span class="keyword">self</span><span class="variable">.document</span><span class="variable">.managedObjectContext</span>;</span><br><span class="line">        <span class="comment">//操作core data......</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//insert=========================================</span></span><br><span class="line">        [<span class="keyword">self</span> saveDataWithContext1:context];</span><br><span class="line">        [<span class="keyword">self</span> saveDataWithContext2:context];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//query=========================================</span></span><br><span class="line">        [<span class="keyword">self</span> fetchPhotoDataWithContext:context];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//update=========================================</span></span><br><span class="line">        [<span class="keyword">self</span> updatePhotoDataWithContext:context];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//delete=========================================</span></span><br><span class="line">        [<span class="keyword">self</span> deletePhotoDataWithContext:context];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用setValue的原始方式保存数据</span></span><br><span class="line">- (<span class="keyword">void</span>)saveDataWithContext1:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSManagedObject</span> *photo = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:context];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSManagedObject</span> *photographer = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photographer"</span> inManagedObjectContext:context];</span><br><span class="line">    </span><br><span class="line">    [photographer setValue:<span class="string">@"LYL"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line">    [photo setValue:<span class="string">@"LYL`s picture"</span> forKey:<span class="string">@"title"</span>];</span><br><span class="line">    [photo setValue:<span class="string">@"flickr-5"</span> forKey:<span class="string">@"thumbnailURL"</span>];</span><br><span class="line">    <span class="comment">//当设置完photo中的relationship之后，photographer的photos 集合会自动添加，无需两边同时设置。</span></span><br><span class="line">    [photo setValue:photographer forKey:<span class="string">@"whoTook"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用NSManagedObject子类的方式保存数据(推荐)</span></span><br><span class="line">- (<span class="keyword">void</span>)saveDataWithContext2:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    Photo *photo2 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:context];</span><br><span class="line">    </span><br><span class="line">    Photographer *photographer2 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photographer"</span> inManagedObjectContext:context];</span><br><span class="line">    photographer2<span class="variable">.name</span> = <span class="string">@"YYC"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只设置Photo的关系</span></span><br><span class="line">    photo2<span class="variable">.title</span> = <span class="string">@"YYC`s picture"</span>;</span><br><span class="line">    photo2<span class="variable">.thumbnailURL</span> = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    photo2<span class="variable">.whoTook</span> = photographer2;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只设置photographer的关系</span></span><br><span class="line">    Photo *photo3 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:context];</span><br><span class="line">    photo3<span class="variable">.title</span> = <span class="string">@"YYC`s picture2"</span>;</span><br><span class="line">    photo3<span class="variable">.thumbnailURL</span> = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    [photographer2 addPhotosObject:photo3];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//查询Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)fetchPhotoDataWithContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"title"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(localizedStandardCompare:)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *serverName = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"thumbnailURL contains %@"</span>,serverName];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.fetchBatchSize</span> = <span class="number">20</span>; <span class="comment">//每次只会取20调数据</span></span><br><span class="line">    request<span class="variable">.fetchLimit</span> = <span class="number">100</span>;<span class="comment">//原本有1000条数据，取到100条就结束，不会再往下取</span></span><br><span class="line">    request<span class="variable">.sortDescriptors</span> = @[sortDescriptor];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [context executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">for</span> (Photo *photo <span class="keyword">in</span> resultList) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)updatePhotoDataWithContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="comment">//先找到要更新的内容</span></span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"title = %@"</span>,<span class="string">@"YYC`s picture2"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [context executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (resultList &amp;&amp; resultList<span class="variable">.count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"更新操作-------------------------------"</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"will update photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">        <span class="comment">//更新操作，在代码上看，只是修改下对象的相关属性。</span></span><br><span class="line">        photo<span class="variable">.title</span> = <span class="string">@"YYC`s picture2222"</span>;</span><br><span class="line">        <span class="comment">//再次查询，发现数据已经更改。此时要注意，本地数据库中可能并未更改，数据库中的更改是自动完成的。</span></span><br><span class="line">        [<span class="keyword">self</span> fetchPhotoDataWithContext:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)deletePhotoDataWithContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="comment">//先找到要删除的内容</span></span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"title = %@"</span>,<span class="string">@"YYC`s picture2222"</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [context executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (resultList &amp;&amp; resultList<span class="variable">.count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"删除操作-------------------------------"</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"will delete photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">        <span class="comment">//删除</span></span><br><span class="line">        [context deleteObject:photo];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//再次查询，发现数据已经删除。此时要注意，本地数据库中可能并未删除，数据库中的删除是自动完成的。</span></span><br><span class="line">        [<span class="keyword">self</span> fetchPhotoDataWithContext:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="苹果官网做法-使用三大核心对象管理Core_Data">苹果官网做法-使用三大核心对象管理Core Data</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  苹果官网做法-使用三大核心对象管理Core Data</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import <span class="title">"ViewController2.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photo.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photographer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController2</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSManagedObjectContext</span> *managedObjectContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController2</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    [<span class="keyword">self</span> initializeCoreData];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//insert=========================================</span></span><br><span class="line">    [<span class="keyword">self</span> savePhotoData];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//query==========================================</span></span><br><span class="line">    <span class="comment">//savePhotoData即使不执行context的save操作，此处照样可查询出数据</span></span><br><span class="line">    [<span class="keyword">self</span> fetchPhotoData];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//update=========================================</span></span><br><span class="line">    [<span class="keyword">self</span> updatePhotoData];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//delete=========================================</span></span><br><span class="line">    [<span class="keyword">self</span> deletePhotoData];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - 苹果官网做法 Initializing the Core Data Stack</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setManagedObjectContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_managedObjectContext) &#123;</span><br><span class="line">        _managedObjectContext = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initializeCoreData</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.xcdatamodel文件，编译后为.momd文件</span></span><br><span class="line">    <span class="built_in">NSURL</span> *modelURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"Model"</span> withExtension:<span class="string">@"momd"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"modelURL : %@"</span>,modelURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectModel</span></span><br><span class="line">    <span class="built_in">NSManagedObjectModel</span> *mom = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</span><br><span class="line">    <span class="built_in">NSAssert</span>(mom != <span class="literal">nil</span>, <span class="string">@"Error initializing Managed Object Model"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSPersistentStoreCoordinator</span></span><br><span class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *psc = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:mom];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectContext</span></span><br><span class="line">    <span class="comment">//initWithConcurrencyType: 初始化，以明确你是使用基于队列的并发模型</span></span><br><span class="line">    <span class="built_in">NSManagedObjectContext</span> *moc = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:<span class="built_in">NSMainQueueConcurrencyType</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//NSManagedObjectContext与NSPersistentStoreCoordinator相关联</span></span><br><span class="line">    [moc setPersistentStoreCoordinator:psc];</span><br><span class="line">    [<span class="keyword">self</span> setManagedObjectContext:moc];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSURL</span> *documentsURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] lastObject];</span><br><span class="line">    <span class="built_in">NSURL</span> *storeURL = [documentsURL URLByAppendingPathComponent:<span class="string">@"Model.sqlite"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"storeURL :%@"</span>,storeURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置NSManagedObjectContext的NSPersistentStoreCoordinator，使之与本地存储文件相关联。</span></span><br><span class="line">    <span class="comment">//这样设置之后，就无需管理本地存储，一切交由NSManagedObjectContext来处理。</span></span><br><span class="line">    <span class="comment">//无需像视频中讲解的那样，需要检查数据库文件是否存在，需要判断数据库文件是否已打开。</span></span><br><span class="line">    <span class="built_in">NSError</span>* error;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.managedObjectContext</span><span class="variable">.persistentStoreCoordinator</span> addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:<span class="literal">nil</span> error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error: %@"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存数据操作</span></span><br><span class="line">- (<span class="keyword">void</span>)savePhotoData</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//----------使用setValue的原始方式保存数据-------------//</span></span><br><span class="line">    <span class="built_in">NSManagedObject</span> *photo = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSManagedObject</span> *photographer = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photographer"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    </span><br><span class="line">    [photographer setValue:<span class="string">@"LYL"</span> forKey:<span class="string">@"name"</span>];</span><br><span class="line">    [photo setValue:<span class="string">@"LYL`s picture"</span> forKey:<span class="string">@"title"</span>];</span><br><span class="line">    [photo setValue:<span class="string">@"flickr-5"</span> forKey:<span class="string">@"thumbnailURL"</span>];</span><br><span class="line">    <span class="comment">//当设置完photo中的relationship之后，photographer的photos 集合会自动添加，无需两边同时设置。</span></span><br><span class="line">    [photo setValue:photographer forKey:<span class="string">@"whoTook"</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//----------使用NSManagedObject子类的方式保存数据(推荐)-------------//</span></span><br><span class="line">    Photo *photo2 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    </span><br><span class="line">    Photographer *photographer2 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photographer"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    photographer2<span class="variable">.name</span> = <span class="string">@"YYC"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只设置Photo的关系</span></span><br><span class="line">    photo2<span class="variable">.title</span> = <span class="string">@"YYC`s picture"</span>;</span><br><span class="line">    photo2<span class="variable">.thumbnailURL</span> = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    photo2<span class="variable">.whoTook</span> = photographer2;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//只设置photographer的关系</span></span><br><span class="line">    Photo *photo3 = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    photo3<span class="variable">.title</span> = <span class="string">@"YYC`s picture2"</span>;</span><br><span class="line">    photo3<span class="variable">.thumbnailURL</span> = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    [photographer2 addPhotosObject:photo3];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//此时进行查询，可以查询出数据，但并没有保存到本地数据库文件。</span></span><br><span class="line">    <span class="comment">//[self fetchPhotoData];</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">    [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">- (<span class="keyword">void</span>)saveManagedObjectContext &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> success = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> save:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="string">@"同步数据至数据库时发生错误"</span> format:<span class="string">@"%@"</span>, [error localizedDescription]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)fetchPhotoData &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"title"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(localizedStandardCompare:)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *serverName = <span class="string">@"flickr-5"</span>;</span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"thumbnailURL contains %@"</span>,serverName];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.fetchBatchSize</span> = <span class="number">20</span>; <span class="comment">//每次只会取20调数据</span></span><br><span class="line">    request<span class="variable">.fetchLimit</span> = <span class="number">100</span>;<span class="comment">//原本有1000条数据，取到100条就结束，不会再往下取</span></span><br><span class="line">    request<span class="variable">.sortDescriptors</span> = @[sortDescriptor];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">for</span> (Photo *photo <span class="keyword">in</span> resultList) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)updatePhotoData &#123;</span><br><span class="line">    <span class="comment">//先找到要更新的内容</span></span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"title = %@"</span>,<span class="string">@"YYC`s picture2"</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (resultList &amp;&amp; resultList<span class="variable">.count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"更新操作-------------------------------"</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"will update photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">        <span class="comment">//更新操作，在代码上看，只是修改下对象的相关属性。</span></span><br><span class="line">        photo<span class="variable">.title</span> = <span class="string">@"YYC`s picture2222"</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">        [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//再次查询，发现数据已经更改。</span></span><br><span class="line">        [<span class="keyword">self</span> fetchPhotoData];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除Photo中的数据</span></span><br><span class="line">- (<span class="keyword">void</span>)deletePhotoData &#123;</span><br><span class="line">    <span class="comment">//先找到要删除的内容</span></span><br><span class="line">    <span class="built_in">NSPredicate</span> *predicate = [<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@"title = %@"</span>,<span class="string">@"YYC`s picture2222"</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *request = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    request<span class="variable">.predicate</span> = predicate;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSError</span> *error;</span><br><span class="line">    <span class="built_in">NSArray</span> *resultList = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> executeFetchRequest:request error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (resultList &amp;&amp; resultList<span class="variable">.count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Photo *photo = resultList[<span class="number">0</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"删除操作-------------------------------"</span>);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"will delete photo : title-%@,thumbnailURL-%@,whoTook-%@"</span>,photo<span class="variable">.title</span>,photo<span class="variable">.thumbnailURL</span>,photo<span class="variable">.whoTook</span><span class="variable">.name</span>);</span><br><span class="line">        <span class="comment">//删除</span></span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> deleteObject:photo];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">        [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//再次查询，发现数据已经删除。</span></span><br><span class="line">        [<span class="keyword">self</span> fetchPhotoData];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h2 id="第二部分：斯坦福大学IOS7公开课_Lecture_13_课程笔记">第二部分：斯坦福大学IOS7公开课 Lecture 13 课程笔记</h2><h3 id="1、Core_Data_和_UITableView">1、Core Data 和 UITableView</h3><h4 id="NSFetchedResultsController_和UITableView_结合的用法">NSFetchedResultsController 和UITableView 结合的用法</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSUInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)sender</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sections] count];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSUInteger</span>)tableView:(<span class="built_in">UITableView</span> *)sender numberOfRowsInSection:(<span class="built_in">NSUInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">     <span class="keyword">return</span> [[[<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sections] objectAtIndex:section] numberOfObjects];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)sender cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = ...;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSManagedObject</span> *managedObject =  [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> objectAtIndexPath:indexPath];</span><br><span class="line">    <span class="comment">// 或者 Photo *photo = (Photo *) ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="NSFetchedResultsController的创建">NSFetchedResultsController的创建</h4><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSFetchRequest *request = [NSFetchRequest <span class="string">fetchRequestWithEntityName:</span>@<span class="string">"Photo"</span>];</span><br><span class="line">request.sortDescriptors = @[[NSSortDescriptor <span class="string">sortDescriptorWithKey:</span>@<span class="string">"title"</span> <span class="string">ascending:</span>YES <span class="string">selector:</span><span class="annotation">@selector</span>(<span class="string">localizedStandardCompare:</span>)]];</span><br><span class="line">equest.predicate = [NSPredicate <span class="string">predicateWithFormat:</span>@<span class="string">"thumbnailURL containers %@"</span>,@<span class="string">"server"</span>];</span><br><span class="line"></span><br><span class="line">NSFetchedResultsController *frc = [[NSFetchedResultsController alloc] <span class="string">initWithFetchRequest:</span>request <span class="string">managedObjectContext:</span>context <span class="string">sectionNameKeyPath:</span>@<span class="string">"whoTook.name"</span> <span class="string">cacheName:</span>@<span class="string">"MyPhotoCache"</span>];</span><br></pre></td></tr></table></figure>
<ul>
<li><p>参数cacheName，缓存名称,如果该参数传nil则不会缓存。</p>
<blockquote>
<p>注意Core Data中的缓存总是磁盘缓存而不是内存缓存。请确保你使用的那个cacheName代表的缓存，总是关联同一个request且request的内容不会发生改变，否则缓存会失效。</p>
</blockquote>
</li>
<li><p>参数sectionNameKeyPath，表示根据返回数据种哪个属性，把数据拆分成不同的section，如果该参数传nil，表示只有一个section。</p>
<blockquote>
<p>注意：使用sectionNameKeyPath时需要确保sortDescriptors必须匹配section keys。换言之，table每行数据的顺序和取回数据的顺序是一致的。所以在sortDescriptors中往往第一个描述器就是按照sectionName进行排序。</p>
</blockquote>
</li>
</ul>
<h4 id="NSFetchedResultsController会观察Core_Data中数据是否发生改变并自动更新Table">NSFetchedResultsController会观察Core Data中数据是否发生改变并自动更新Table</h4><p>内部是使用key-value observing 机制实现的。当它观察到数据改变，会向它的Delegate发送消息：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="id">#pragma</span> <span class="tag">mark</span> <span class="tag">NSFetchedResultsControllerDelegate</span></span><br><span class="line"><span class="comment">//别忘记设置fetchedResultsController.delegate = self;</span></span><br><span class="line"><span class="tag">-</span> (void)<span class="tag">controller</span>:(NSFetchedResultsController *)<span class="tag">controller</span> <span class="tag">didChangeObject</span>:(id)<span class="tag">anObject</span> <span class="tag">atIndexPath</span>:(nullable NSIndexPath *)<span class="tag">indexPath</span> <span class="tag">forChangeType</span>:(NSFetchedResultsChangeType)<span class="tag">type</span> <span class="tag">newIndexPath</span>:(nullable NSIndexPath *)<span class="tag">newIndexPath</span>&#123;</span><br><span class="line">    <span class="comment">//让UITableView更新数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2、斯坦福大学IOS7公开课_Lecture_13_Demo">2、斯坦福大学IOS7公开课 Lecture 13 Demo</h3><p>课程往下就可使讲解一个完整的Demo了，Demo源码可以到<a href="http://web.stanford.edu/class/cs193p/cgi-bin/drupal/downloads-2013-winter" target="_blank" rel="external">这里</a>下载。</p>
<p>我觉得看课程中代码意义不是很大，还是自己写一份比较好理解，下面是我的代码：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  CoreData与UITableView结合</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#import <span class="title">"ViewController3.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">&lt;CoreData/CoreData.h&gt;</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photo.h"</span></span></span><br><span class="line"><span class="preprocessor">#import <span class="title">"Photographer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#define ScreenWidth  [UIScreen mainScreen].bounds.size.width</span></span><br><span class="line"><span class="preprocessor">#define ScreenHeight [UIScreen mainScreen].bounds.size.height</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *tableCellIdentifier = <span class="string">@"Photo"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController3</span> ()&lt;<span class="title">UITableViewDataSource</span>,<span class="title">NSFetchedResultsControllerDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSManagedObjectContext</span> *managedObjectContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">UITableView</span> *tableView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSFetchedResultsController</span> *fetchedResultsController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController3</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> setupTableView];</span><br><span class="line">    [<span class="keyword">self</span> setupButtons];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> initializeCoreData];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> fireFetchedResultsController];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - Initializing the Core Data Stack</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setManagedObjectContext:(<span class="built_in">NSManagedObjectContext</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_managedObjectContext) &#123;</span><br><span class="line">        _managedObjectContext = context;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initializeCoreData</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//.xcdatamodel文件，编译后为.momd文件</span></span><br><span class="line">    <span class="built_in">NSURL</span> *modelURL = [[<span class="built_in">NSBundle</span> mainBundle] URLForResource:<span class="string">@"Model"</span> withExtension:<span class="string">@"momd"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"modelURL : %@"</span>,modelURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectModel</span></span><br><span class="line">    <span class="built_in">NSManagedObjectModel</span> *mom = [[<span class="built_in">NSManagedObjectModel</span> alloc] initWithContentsOfURL:modelURL];</span><br><span class="line">    <span class="built_in">NSAssert</span>(mom != <span class="literal">nil</span>, <span class="string">@"Error initializing Managed Object Model"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSPersistentStoreCoordinator</span></span><br><span class="line">    <span class="built_in">NSPersistentStoreCoordinator</span> *psc = [[<span class="built_in">NSPersistentStoreCoordinator</span> alloc] initWithManagedObjectModel:mom];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建NSManagedObjectContext</span></span><br><span class="line">    <span class="comment">//initWithConcurrencyType: 初始化，以明确你是使用基于队列的并发模型</span></span><br><span class="line">    <span class="built_in">NSManagedObjectContext</span> *moc = [[<span class="built_in">NSManagedObjectContext</span> alloc] initWithConcurrencyType:<span class="built_in">NSMainQueueConcurrencyType</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//NSManagedObjectContext与NSPersistentStoreCoordinator相关联</span></span><br><span class="line">    [moc setPersistentStoreCoordinator:psc];</span><br><span class="line">    [<span class="keyword">self</span> setManagedObjectContext:moc];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSFileManager</span> *fileManager = [<span class="built_in">NSFileManager</span> defaultManager];</span><br><span class="line">    <span class="built_in">NSURL</span> *documentsURL = [[fileManager URLsForDirectory:<span class="built_in">NSDocumentDirectory</span> inDomains:<span class="built_in">NSUserDomainMask</span>] lastObject];</span><br><span class="line">    <span class="built_in">NSURL</span> *storeURL = [documentsURL URLByAppendingPathComponent:<span class="string">@"Model2.sqlite"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"storeURL :%@"</span>,storeURL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//设置NSManagedObjectContext的NSPersistentStoreCoordinator，使之与本地存储文件相关联。</span></span><br><span class="line">    <span class="comment">//这样设置之后，就无需管理本地存储，一切交由NSManagedObjectContext来处理。</span></span><br><span class="line">    <span class="comment">//无需像视频中讲解的那样，需要检查数据库文件是否存在，需要判断数据库文件是否已打开。</span></span><br><span class="line">    <span class="built_in">NSError</span>* error;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.managedObjectContext</span><span class="variable">.persistentStoreCoordinator</span> addPersistentStoreWithType:<span class="built_in">NSSQLiteStoreType</span> configuration:<span class="literal">nil</span> URL:storeURL options:<span class="literal">nil</span> error:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error: %@"</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="preprocessor">#pragma mark - Core Data Methord</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  利用上下文对象，将数据同步到本地数据库</span><br><span class="line"> **/</span></span><br><span class="line">- (<span class="keyword">void</span>)saveManagedObjectContext &#123;</span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">BOOL</span> success = [<span class="keyword">self</span><span class="variable">.managedObjectContext</span> save:&amp;error];</span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        [<span class="built_in">NSException</span> raise:<span class="string">@"同步数据至数据库时发生错误"</span> format:<span class="string">@"%@"</span>, [error localizedDescription]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> *  批量插入数据</span><br><span class="line"> *  添加5个Photos，每次添加他们都有一个新的Photographer</span><br><span class="line"> **/</span></span><br><span class="line">- (<span class="keyword">void</span>)addPhotosWithNewPhotographer &#123;</span><br><span class="line">    <span class="built_in">NSUInteger</span> recordTime = [[<span class="built_in">NSDate</span> date] timeIntervalSince1970]*<span class="number">1000</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *photographerName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Photographer-%ld"</span>,recordTime];</span><br><span class="line">    </span><br><span class="line">    Photographer *photographer = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photographer"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">    photographer<span class="variable">.name</span> = photographerName;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//NSUInteger recordTime2 = [[NSDate date] timeIntervalSince1970]*1000*1000;//微秒</span></span><br><span class="line">        Photo *photo = [<span class="built_in">NSEntityDescription</span> insertNewObjectForEntityForName:<span class="string">@"Photo"</span> inManagedObjectContext:<span class="keyword">self</span><span class="variable">.managedObjectContext</span>];</span><br><span class="line">        photo<span class="variable">.title</span> = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Photo-%ld-%ld"</span>,recordTime,i];</span><br><span class="line">        photo<span class="variable">.whoTook</span> = photographer;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 利用上下文对象，将数据同步到本地数据库</span></span><br><span class="line">    [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - UI</span></span><br><span class="line">- (<span class="built_in">UITableView</span> *)tableView &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_tableView) &#123;</span><br><span class="line">        </span><br><span class="line">        _tableView = [[<span class="built_in">UITableView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">22</span>, ScreenWidth, ScreenHeight-<span class="number">77</span>)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _tableView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupTableView &#123;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.view</span> addSubview:<span class="keyword">self</span><span class="variable">.tableView</span>];</span><br><span class="line">    <span class="keyword">self</span><span class="variable">.tableView</span><span class="variable">.dataSource</span> = <span class="keyword">self</span>;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.tableView</span> registerClass:[<span class="built_in">UITableViewCell</span> class] forCellReuseIdentifier:tableCellIdentifier];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setupButtons &#123;</span><br><span class="line">    <span class="built_in">UIButton</span> *addButton = [[<span class="built_in">UIButton</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(ScreenWidth/<span class="number">4</span>, ScreenHeight-<span class="number">40</span>, ScreenWidth/<span class="number">2</span>, <span class="number">30</span>)];</span><br><span class="line">    addButton<span class="variable">.backgroundColor</span> = [<span class="built_in">UIColor</span> orangeColor];</span><br><span class="line">    addButton<span class="variable">.titleLabel</span><span class="variable">.font</span> = [<span class="built_in">UIFont</span> systemFontOfSize:<span class="number">10</span>];</span><br><span class="line">    [addButton setTitle:<span class="string">@"Add Photos With New Photographer"</span> forState:<span class="built_in">UIControlStateNormal</span>];</span><br><span class="line">    addButton<span class="variable">.showsTouchWhenHighlighted</span> = <span class="literal">YES</span>;</span><br><span class="line">    [addButton addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(addPhotosWithNewPhotographer) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.view</span> addSubview:addButton];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSFetchedResultsController</span> *)fetchedResultsController &#123;</span><br><span class="line">    <span class="keyword">if</span> (_fetchedResultsController != <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> _fetchedResultsController;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSFetchRequest</span> *fetchRequest = [<span class="built_in">NSFetchRequest</span> fetchRequestWithEntityName:<span class="string">@"Photo"</span>];</span><br><span class="line">    [fetchRequest setFetchBatchSize:<span class="number">20</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor1 = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"whoTook.name"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(localizedStandardCompare:)];</span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor2 = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"title"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(localizedStandardCompare:)];</span><br><span class="line">    <span class="built_in">NSArray</span> *sortDescriptors = @[sortDescriptor1,sortDescriptor2];</span><br><span class="line"></span><br><span class="line">    [fetchRequest setSortDescriptors:sortDescriptors];</span><br><span class="line"></span><br><span class="line">    _fetchedResultsController = [[<span class="built_in">NSFetchedResultsController</span> alloc]</span><br><span class="line">                                       initWithFetchRequest:(<span class="built_in">NSFetchRequest</span> *)fetchRequest</span><br><span class="line">                                       managedObjectContext:(<span class="built_in">NSManagedObjectContext</span> *)<span class="keyword">self</span><span class="variable">.managedObjectContext</span></span><br><span class="line">                                       sectionNameKeyPath:<span class="string">@"whoTook.name"</span></span><br><span class="line">                                       cacheName:<span class="string">@"MyPhotoCache"</span>];</span><br><span class="line">    _fetchedResultsController<span class="variable">.delegate</span> = <span class="keyword">self</span>;</span><br><span class="line">    <span class="keyword">return</span> _fetchedResultsController;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)fireFetchedResultsController &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span>(![<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> performFetch: &amp;error])&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"Unresolved error %@, %@"</span>, error, [error userInfo]);</span><br><span class="line">        <span class="comment">//exit(-1);</span></span><br><span class="line">        abort();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sections] count];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *sections = [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sections];</span><br><span class="line">    <span class="keyword">id</span>&lt;<span class="built_in">NSFetchedResultsSectionInfo</span>&gt; sectionInfo = sections[section];</span><br><span class="line">    <span class="keyword">return</span> [sectionInfo numberOfObjects];</span><br><span class="line">    <span class="comment">//可以简写为：</span></span><br><span class="line">    <span class="comment">//return [[[self.fetchedResultsController sections] objectAtIndex:section] numberOfObjects];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView titleForHeaderInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *sections = [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span>  sections];</span><br><span class="line">    <span class="keyword">id</span>&lt;<span class="built_in">NSFetchedResultsSectionInfo</span>&gt; sectionInfo = sections[section];</span><br><span class="line">    <span class="keyword">return</span> [sectionInfo name];</span><br><span class="line">    <span class="comment">//可以简写为：</span></span><br><span class="line">    <span class="comment">//return [[[self.fetchedResultsController sections] objectAtIndex:section] name];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView sectionForSectionIndexTitle:(<span class="built_in">NSString</span> *)title atIndex:(<span class="built_in">NSInteger</span>)index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sectionForSectionIndexTitle:title atIndex:index];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span> *)sectionIndexTitlesForTableView:(<span class="built_in">UITableView</span> *)tableView</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> sectionIndexTitles];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:tableCellIdentifier forIndexPath:indexPath];</span><br><span class="line">    Photo *photo = [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> objectAtIndexPath:indexPath];</span><br><span class="line">    </span><br><span class="line">    cell<span class="variable">.textLabel</span><span class="variable">.text</span> = photo<span class="variable">.title</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//开启编辑</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)tableView:(<span class="built_in">UITableView</span> *)tableView canEditRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//编辑的具体逻辑</span></span><br><span class="line">- (<span class="keyword">void</span>)tableView:(<span class="built_in">UITableView</span> *)tableView commitEditingStyle:(<span class="built_in">UITableViewCellEditingStyle</span>)editingStyle forRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (editingStyle == <span class="built_in">UITableViewCellEditingStyleDelete</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//通过coreData删除对象</span></span><br><span class="line">        Photo *photo = [<span class="keyword">self</span><span class="variable">.fetchedResultsController</span> objectAtIndexPath:indexPath];</span><br><span class="line">        [<span class="keyword">self</span><span class="variable">.managedObjectContext</span>  deleteObject:photo];</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> saveManagedObjectContext];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark NSFetchedResultsControllerDelegate</span></span><br><span class="line">- (<span class="keyword">void</span>)controllerWillChangeContent:(<span class="built_in">NSFetchedResultsController</span> *)controller &#123;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.tableView</span> beginUpdates];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)controllerDidChangeContent:(<span class="built_in">NSFetchedResultsController</span> *)controller &#123;</span><br><span class="line">    [<span class="keyword">self</span><span class="variable">.tableView</span> endUpdates];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)controller:(<span class="built_in">NSFetchedResultsController</span> *)controller</span><br><span class="line">   didChangeObject:(<span class="keyword">id</span>)anObject</span><br><span class="line">       atIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath</span><br><span class="line">     forChangeType:(<span class="built_in">NSFetchedResultsChangeType</span>)type</span><br><span class="line">      newIndexPath:(<span class="built_in">NSIndexPath</span> *)newIndexPath &#123;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeInsert</span>:</span><br><span class="line">            [<span class="keyword">self</span><span class="variable">.tableView</span> insertRowsAtIndexPaths:[<span class="built_in">NSArray</span> arrayWithObject:newIndexPath]</span><br><span class="line">                                  withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeDelete</span>:</span><br><span class="line">            [<span class="keyword">self</span><span class="variable">.tableView</span> deleteRowsAtIndexPaths:[<span class="built_in">NSArray</span> arrayWithObject:indexPath]</span><br><span class="line">                                  withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeUpdate</span>: &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *sectionKeyPath = [controller sectionNameKeyPath];</span><br><span class="line">            <span class="keyword">if</span> (sectionKeyPath == <span class="literal">nil</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">NSManagedObject</span> *changedObject = [controller objectAtIndexPath:indexPath];</span><br><span class="line">            <span class="built_in">NSArray</span> *keyParts = [sectionKeyPath componentsSeparatedByString:<span class="string">@"."</span>];</span><br><span class="line">            <span class="keyword">id</span> currentKeyValue = [changedObject valueForKeyPath:sectionKeyPath];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; [keyParts count] - <span class="number">1</span>; i++) &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *onePart = [keyParts objectAtIndex:i];</span><br><span class="line">                changedObject = [changedObject valueForKey:onePart];</span><br><span class="line">            &#125;</span><br><span class="line">            sectionKeyPath = [keyParts lastObject];</span><br><span class="line">            <span class="built_in">NSDictionary</span> *committedValues = [changedObject committedValuesForKeys:<span class="literal">nil</span>];</span><br><span class="line">            <span class="keyword">if</span> ([[committedValues valueForKeyPath:sectionKeyPath]isEqual:currentKeyValue])</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">NSUInteger</span> tableSectionCount = [<span class="keyword">self</span><span class="variable">.tableView</span> numberOfSections];</span><br><span class="line">            <span class="built_in">NSUInteger</span> frcSectionCount = [[controller sections] count];</span><br><span class="line">            <span class="keyword">if</span> (tableSectionCount != frcSectionCount) &#123;</span><br><span class="line">                <span class="comment">// Need to insert a section</span></span><br><span class="line">                <span class="built_in">NSArray</span> *sections = controller<span class="variable">.sections</span>;</span><br><span class="line">                <span class="built_in">NSInteger</span> newSectionLocation = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> oneSection <span class="keyword">in</span> sections) &#123;</span><br><span class="line">                    <span class="built_in">NSString</span> *sectionName = [oneSection name];</span><br><span class="line">                    <span class="keyword">if</span> ([currentKeyValue isEqual:sectionName]) &#123;</span><br><span class="line">                        newSectionLocation = [sections indexOfObject:oneSection];</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (newSectionLocation == -<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">return</span>; <span class="comment">// uh oh</span></span><br><span class="line">                <span class="keyword">if</span> (!((newSectionLocation == <span class="number">0</span>) &amp;&amp; (tableSectionCount == <span class="number">1</span>)</span><br><span class="line">                      &amp;&amp; ([<span class="keyword">self</span><span class="variable">.tableView</span> numberOfRowsInSection:<span class="number">0</span>] == <span class="number">0</span>)))</span><br><span class="line">                    [<span class="keyword">self</span><span class="variable">.tableView</span> insertSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:newSectionLocation]</span><br><span class="line">                                  withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">                <span class="built_in">NSUInteger</span> indices[<span class="number">2</span>] = &#123;newSectionLocation, <span class="number">0</span>&#125;;</span><br><span class="line">                newIndexPath = [[<span class="built_in">NSIndexPath</span> alloc] initWithIndexes:indices length:<span class="number">2</span>];</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeMove</span>:</span><br><span class="line">            <span class="keyword">if</span> (newIndexPath != <span class="literal">nil</span>) &#123;</span><br><span class="line">                [<span class="keyword">self</span><span class="variable">.tableView</span> deleteRowsAtIndexPaths:[<span class="built_in">NSArray</span> arrayWithObject:indexPath]</span><br><span class="line">                                      withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">                [<span class="keyword">self</span><span class="variable">.tableView</span> insertRowsAtIndexPaths: [<span class="built_in">NSArray</span> arrayWithObject:newIndexPath]</span><br><span class="line">                                      withRowAnimation: <span class="built_in">UITableViewRowAnimationRight</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span><span class="variable">.tableView</span> reloadSections:[<span class="built_in">NSIndexSet</span></span><br><span class="line">                                                indexSetWithIndex:[indexPath section]]withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)controller:(<span class="built_in">NSFetchedResultsController</span> *)controller</span><br><span class="line">  didChangeSection:(<span class="keyword">id</span> &lt;<span class="built_in">NSFetchedResultsSectionInfo</span>&gt;)sectionInfo</span><br><span class="line">           atIndex:(<span class="built_in">NSUInteger</span>)sectionIndex</span><br><span class="line">     forChangeType:(<span class="built_in">NSFetchedResultsChangeType</span>)type &#123;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeInsert</span>:</span><br><span class="line">            <span class="keyword">if</span> (!((sectionIndex == <span class="number">0</span>) &amp;&amp; ([<span class="keyword">self</span><span class="variable">.tableView</span> numberOfSections] == <span class="number">1</span>)</span><br><span class="line">                  &amp;&amp; ([<span class="keyword">self</span><span class="variable">.tableView</span> numberOfRowsInSection:<span class="number">0</span>] == <span class="number">0</span>)))</span><br><span class="line">                [<span class="keyword">self</span><span class="variable">.tableView</span> insertSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:sectionIndex]</span><br><span class="line">                              withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeDelete</span>:</span><br><span class="line">            <span class="keyword">if</span> (!((sectionIndex == <span class="number">0</span>) &amp;&amp; ([<span class="keyword">self</span><span class="variable">.tableView</span> numberOfSections] == <span class="number">1</span>)</span><br><span class="line">                  &amp;&amp; ([<span class="keyword">self</span><span class="variable">.tableView</span> numberOfRowsInSection:<span class="number">0</span>] == <span class="number">0</span>)))</span><br><span class="line">                [<span class="keyword">self</span><span class="variable">.tableView</span> deleteSections:[<span class="built_in">NSIndexSet</span> indexSetWithIndex:sectionIndex]</span><br><span class="line">                              withRowAnimation:<span class="built_in">UITableViewRowAnimationFade</span>];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeMove</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSFetchedResultsChangeUpdate</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考</p>
<p><a href="https://developer.apple.com/library/prerelease/tvos/documentation/Cocoa/Conceptual/CoreData/index.html#//apple_ref/doc/uid/TP40001075-CH2-SW1" target="_blank" rel="external">Core Data Programming Guide</a> </p>
<p><a href="http://blog.csdn.net/q199109106q/article/details/8563438/" target="_blank" rel="external">Core Data入门</a></p>
<p><a href="http://blog.sina.com.cn/s/blog_6daf50130101643n.html" target="_blank" rel="external">在建好的项目中加入CoreData(轉)</a></p>
<p><a href="http://justsee.iteye.com/blog/1881110" target="_blank" rel="external">Core Data的理解</a></p>
<p><a href="http://objccn.io/issue-4-2/" target="_blank" rel="external">一个完整的 Core Data 应用</a></p>
<p><a href="http://www.cnblogs.com/xiaodao/archive/2012/10/08/2715477.html" target="_blank" rel="external">iphone数据存储之－－ Core Data的使用（一）</a></p>
<p><a href="http://www.cnblogs.com/xiaodao/archive/2012/10/09/2716579.html#2519731" target="_blank" rel="external">iphone数据存储之－－ Core Data的使用（二）</a></p>
<p><a href="http://blog.csdn.net/jinkelei/article/details/6871403" target="_blank" rel="external">CoreData学习笔记（二）</a></p>
<p><a href="http://www.cnblogs.com/ludashi/p/3947630.html" target="_blank" rel="external">iOS开发之表视图爱上CoreData</a></p>
</blockquote>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Core-Data/" rel="tag">#Core Data</a>
          
            <a href="/tags/本地存储/" rel="tag">#本地存储</a>
          
            <a href="/tags/缓存/" rel="tag">#缓存</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/11/24/发布企业级iOS应用/" rel="prev">发布企业级iOS应用</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/09/21/iOS中数据持久化学习笔记/" rel="next">iOS中数据持久化学习笔记</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


            </div>

            

            
              <div class="comments" id="comments">
                
                  <div id="disqus_thread">
                    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                  </div>
                
              </div>
            
        </div>

        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/avatar.png" alt="YL" itemprop="image"/>
          <p class="site-author-name" itemprop="name">YL</p>
        </div>
        <p class="site-description motion-element" itemprop="description">IOS技术总结</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://aliang9585.github.io" target="_blank">GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/ytlvy" target="_blank">Twitter</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://nshipster.com" target="_blank">NSHipster</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.mikeash.com/pyblog" target="_blank">NSBlog</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.objc.io" target="_blank">objcio</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.raywenderlich.com" target="_blank">raywenderlich</a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#第一部分：斯坦福大学IOS7公开课_Lecture_12_课程笔记"><span class="nav-number">1.</span> <span class="nav-text">第一部分：斯坦福大学IOS7公开课 Lecture 12 课程笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、创建工程"><span class="nav-number">1.1.</span> <span class="nav-text">1、创建工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、创建-xcdatamodeld文件"><span class="nav-number">1.2.</span> <span class="nav-text">2、创建.xcdatamodeld文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、创建实体（Entity）和属性（Attribute）"><span class="nav-number">1.3.</span> <span class="nav-text">3、创建实体（Entity）和属性（Attribute）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、建立Relationship"><span class="nav-number">1.4.</span> <span class="nav-text">4、建立Relationship</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、改变实体映射关系（一对一改为一对多）"><span class="nav-number">1.5.</span> <span class="nav-text">5、改变实体映射关系（一对一改为一对多）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6、删除规则"><span class="nav-number">1.6.</span> <span class="nav-text">6、删除规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7、代码中如何使用"><span class="nav-number">1.7.</span> <span class="nav-text">7、代码中如何使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#补充第7节的内容：使用苹果官网的做法所需的3个主要对象"><span class="nav-number">1.7.1.</span> <span class="nav-text">补充第7节的内容：使用苹果官网的做法所需的3个主要对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#（1）The_managed_object_context_(NSManagedObjectContext)："><span class="nav-number">1.7.1.1.</span> <span class="nav-text">（1）The managed object context (NSManagedObjectContext)：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（2）_The_persistent_store_coordinator_(NSPersistentStoreCoordinator)："><span class="nav-number">1.7.1.2.</span> <span class="nav-text">（2） The persistent store coordinator (NSPersistentStoreCoordinator)：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#（3）The_managed_object_model_(NSManagedObjectModel)："><span class="nav-number">1.7.1.3.</span> <span class="nav-text">（3）The managed object model (NSManagedObjectModel)：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#实体（Entity）"><span class="nav-number">1.7.1.3.1.</span> <span class="nav-text">实体（Entity）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#属性（Property）"><span class="nav-number">1.7.1.3.2.</span> <span class="nav-text">属性（Property）</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8、创建UIManagedDocument对象"><span class="nav-number">1.8.</span> <span class="nav-text">8、创建UIManagedDocument对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9、把UIManagedDocument对象创建在磁盘上并打开"><span class="nav-number">1.9.</span> <span class="nav-text">9、把UIManagedDocument对象创建在磁盘上并打开</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10、UIDocumentState"><span class="nav-number">1.10.</span> <span class="nav-text">10、UIDocumentState</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11、获取NSManagedObjectContext对象"><span class="nav-number">1.11.</span> <span class="nav-text">11、获取NSManagedObjectContext对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12、UIManagedDocument多实例"><span class="nav-number">1.12.</span> <span class="nav-text">12、UIManagedDocument多实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#补充8、9、10、11、12节内容：初始化Core_Data上下文环境"><span class="nav-number">1.12.1.</span> <span class="nav-text">补充8、9、10、11、12节内容：初始化Core Data上下文环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置XCode运行时输出SQL语句："><span class="nav-number">1.12.2.</span> <span class="nav-text">设置XCode运行时输出SQL语句：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化Core_Data上下文环境"><span class="nav-number">1.12.3.</span> <span class="nav-text">初始化Core Data上下文环境</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13、插入操作"><span class="nav-number">1.13.</span> <span class="nav-text">13、插入操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）往数据库中插入对象"><span class="nav-number">1.13.1.</span> <span class="nav-text">（1）往数据库中插入对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）获取和设置属性"><span class="nav-number">1.13.2.</span> <span class="nav-text">（2）获取和设置属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）保存到磁盘"><span class="nav-number">1.13.3.</span> <span class="nav-text">（3）保存到磁盘</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14、生成实体的子类"><span class="nav-number">1.14.</span> <span class="nav-text">14、生成实体的子类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#（1）@dynamic"><span class="nav-number">1.14.1.</span> <span class="nav-text">（1）@dynamic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（2）CoreDataGeneratedAccessors"><span class="nav-number">1.14.2.</span> <span class="nav-text">（2）CoreDataGeneratedAccessors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#（3）我们要手动往实体的子类中添加代码，应该使用Category。"><span class="nav-number">1.14.3.</span> <span class="nav-text">（3）我们要手动往实体的子类中添加代码，应该使用Category。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#补充13、14节内容：使用苹果官网做法往数据库中插入数据"><span class="nav-number">1.14.4.</span> <span class="nav-text">补充13、14节内容：使用苹果官网做法往数据库中插入数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#15、删除操作"><span class="nav-number">1.15.</span> <span class="nav-text">15、删除操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#补充15节内容：使用苹果官网做法往数据库中更新、删除数据"><span class="nav-number">1.15.1.</span> <span class="nav-text">补充15节内容：使用苹果官网做法往数据库中更新、删除数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#16、查询操作"><span class="nav-number">1.16.</span> <span class="nav-text">16、查询操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#第一步：创建NSFetchRequest"><span class="nav-number">1.16.1.</span> <span class="nav-text">第一步：创建NSFetchRequest</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#NSSortDescriptors"><span class="nav-number">1.16.1.1.</span> <span class="nav-text">NSSortDescriptors</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NSPredicate"><span class="nav-number">1.16.1.2.</span> <span class="nav-text">NSPredicate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#高级查询"><span class="nav-number">1.16.1.3.</span> <span class="nav-text">高级查询</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第二步：执行NSFetchRequest"><span class="nav-number">1.16.2.</span> <span class="nav-text">第二步：执行NSFetchRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#补充16节内容：使用苹果官网做法查询数据"><span class="nav-number">1.16.3.</span> <span class="nav-text">补充16节内容：使用苹果官网做法查询数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17、关于性能"><span class="nav-number">1.17.</span> <span class="nav-text">17、关于性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#18、关于线程"><span class="nav-number">1.18.</span> <span class="nav-text">18、关于线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#19、课程提到但没讲的内容"><span class="nav-number">1.19.</span> <span class="nav-text">19、课程提到但没讲的内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#20、完整代码"><span class="nav-number">1.20.</span> <span class="nav-text">20、完整代码</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#斯坦福公开课做法-使用UIManagedDocument管理Core_Data"><span class="nav-number">1.20.1.</span> <span class="nav-text">斯坦福公开课做法-使用UIManagedDocument管理Core Data</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#苹果官网做法-使用三大核心对象管理Core_Data"><span class="nav-number">1.20.2.</span> <span class="nav-text">苹果官网做法-使用三大核心对象管理Core Data</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二部分：斯坦福大学IOS7公开课_Lecture_13_课程笔记"><span class="nav-number">2.</span> <span class="nav-text">第二部分：斯坦福大学IOS7公开课 Lecture 13 课程笔记</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、Core_Data_和_UITableView"><span class="nav-number">2.1.</span> <span class="nav-text">1、Core Data 和 UITableView</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#NSFetchedResultsController_和UITableView_结合的用法"><span class="nav-number">2.1.1.</span> <span class="nav-text">NSFetchedResultsController 和UITableView 结合的用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSFetchedResultsController的创建"><span class="nav-number">2.1.2.</span> <span class="nav-text">NSFetchedResultsController的创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NSFetchedResultsController会观察Core_Data中数据是否发生改变并自动更新Table"><span class="nav-number">2.1.3.</span> <span class="nav-text">NSFetchedResultsController会观察Core Data中数据是否发生改变并自动更新Table</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、斯坦福大学IOS7公开课_Lecture_13_Demo"><span class="nav-number">2.2.</span> <span class="nav-text">2、斯坦福大学IOS7公开课 Lecture 13 Demo</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
        <div class="footer-inner">
            <div class="copyright" >
  
  &copy; &nbsp;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">YL</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



        </div>
    </footer>

    <div class="back-to-top"></div>
</div>

<script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  

    <script type="text/javascript">
      var disqus_shortname = 'aliang9585githubio';
      var disqus_identifier = '2015/10/30/Core Data入门教程/';
      var disqus_title = 'Core Data入门教程';
      var disqus_url = 'http://aliang9585.github.io/2015/10/30/Core Data入门教程/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.4"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.4"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.4" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>


  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.4" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




<script type="text/javascript">
    $(document).ready(function () {
        if (CONFIG.sidebar === 'always') {
            displaySidebar();
        }
    });
</script>








<!-- lazyload -->
<script type="text/javascript" src="/js/lazyload.js"></script>
<script type="text/javascript">
    jQuery(function () {
        jQuery("#posts img").lazyload({
            placeholder: "/images/loading.gif",
            effect: "fadeIn"
        });
    });
</script>
</body>
</html>
